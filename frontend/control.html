<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inverter Controls</title>
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="css/shared-styles.css" />
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/firebase-auth.js"></script>
  <script src="js/api-client.js"></script>
  <script src="js/shared-utils.js"></script>
  <script src="js/app-shell.js"></script>
  <style>
    /* Page-specific styles */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent-blue);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .hint {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
      padding: 10px 14px;
      background: rgba(88, 166, 255, 0.05);
      border-left: 3px solid var(--accent-blue);
      border-radius: 6px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: linear-gradient(145deg, rgba(33, 38, 45, 0.9), rgba(22, 27, 34, 0.95));
      border: 1px solid rgba(48, 54, 61, 0.6);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .card:hover {
      border-color: rgba(88, 166, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(48, 54, 61, 0.4);
    }
    .card-header h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    .card-body {
      padding: 16px 18px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 14px;
      background: rgba(33, 38, 45, 0.8);
      border: 1px solid rgba(48, 54, 61, 0.8);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      font-family: inherit;
    }
    .btn:hover {
      background: rgba(48, 54, 61, 0.8);
      border-color: rgba(88, 166, 255, 0.4);
      transform: translateY(-1px);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn-primary {
      background: linear-gradient(135deg, #238636, #1a7f37);
      border-color: #238636;
      color: #fff;
      font-weight: 500;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2ea043, #238636);
      border-color: #2ea043;
    }
    .btn-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    .input {
      width: 100%;
      padding: 9px 12px;
      background: rgba(13, 17, 23, 0.6);
      border: 1px solid rgba(48, 54, 61, 0.8);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    .input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
    }
    .input::placeholder {
      color: #484f58;
    }
    select.input {
      cursor: pointer;
    }
    .input-group {
      margin-bottom: 12px;
    }
    .input-group label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    .input-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(48, 54, 61, 0.4);
    }
    .output-panel {
      background: linear-gradient(145deg, rgba(33, 38, 45, 0.9), rgba(22, 27, 34, 0.95));
      border: 1px solid rgba(48, 54, 61, 0.6);
      border-radius: 12px;
      overflow: hidden;
    }
    .output-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(48, 54, 61, 0.4);
    }
    .output-header h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 600;
      margin: 0;
    }
    .output-body {
      padding: 0;
    }
    .output-content {
      background: #010409;
      padding: 14px;
      border-radius: 0;
      overflow: auto;
      max-height: 500px;
      min-height: 200px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #7ee787;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .status-message {
      padding: 10px 14px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .status-message.success {
      background: rgba(35, 134, 54, 0.15);
      border: 1px solid rgba(35, 134, 54, 0.3);
      color: #7ee787;
    }
    .status-message.error {
      background: rgba(248, 81, 73, 0.15);
      border: 1px solid rgba(248, 81, 73, 0.3);
      color: #ff7b72;
    }
    .status-message.info {
      background: rgba(88, 166, 255, 0.15);
      border: 1px solid rgba(88, 166, 255, 0.3);
      color: #79c0ff;
    }
  </style>
</head>
<body>
  <nav class="nav-main">
    <div class="nav-links">
      <a href="/" class="nav-link">üè† Overview</a>
      <a href="/roi.html" class="nav-link">üí≤ Automation ROI</a>
      <a href="/test.html" class="nav-link">üß™ Automation Lab</a>
      <a href="/history.html" class="nav-link">üìä Reports</a>
      <a href="/control.html" class="nav-link">üéÆ Controls</a>
      <a href="/settings.html" class="nav-link">‚öôÔ∏è Settings</a>
      <a href="/curtailment-discovery.html" class="nav-link" id="topologyNavLink" style="display: none;">üî¨ WIP - Topology Discovery</a>
      <a href="/tesla-integration.html" class="nav-link" id="teslaNavLink" style="display: none;">‚ö° WIP - Tesla Integration</a>
    </div>
    <div class="nav-right">
      <div class="user-menu" data-user-menu>
        <button class="user-avatar" type="button" data-user-avatar>
          <span data-user-initials>?</span>
        </button>
        <div class="user-dropdown" data-user-dropdown>
          <div class="user-dropdown-header">
            <div class="user-name" data-user-name>Guest</div>
            <div class="user-email" data-user-email>Not signed in</div>
          </div>
          <button class="user-dropdown-item" type="button" data-go-settings>‚öôÔ∏è Settings</button>
          <button class="user-dropdown-item" type="button" data-contact-us>üí¨ Contact Us</button>
          <button class="user-dropdown-item danger" type="button" data-signout>üö™ Sign Out</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container page-shell">
    <header>
      <h1><span style="font-size:1.8rem">üéõÔ∏è</span> Advanced Controls</h1>
    </header>

    <div class="hint">
      ‚ÑπÔ∏è These advanced controls were moved here to keep the main dashboard clean and focused. Configure device settings, work modes, and access detailed system information.
    </div>

    <div class="grid">
      
      <!-- Battery SoC Settings -->
      <div class="card">
        <div class="card-header">
          <h2>üîã Battery SoC Limits</h2>
        </div>
        <div class="card-body">
          <form id="form-batterySoc" onsubmit="setBatterySoc(event)">
            <div class="input-row">
              <div class="input-group">
                <label>Min SoC (%)</label>
                <input type="number" name="minSoc" class="input" min="10" max="100" placeholder="e.g., 10" required>
              </div>
              <div class="input-group">
                <label>Min SoC on Grid (%)</label>
                <input type="number" name="minSocOnGrid" class="input" min="10" max="100" placeholder="e.g., 10" required>
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Max SoC (%)</label>
                <input type="number" name="maxSoc" class="input" min="10" max="100" placeholder="e.g., 90" required>
              </div>
            </div>
            <div id="status-batterySoc"></div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary" style="flex:1">üíæ Save Settings</button>
              <button type="button" class="btn" onclick="getBatterySoc()">üîÑ Load Current</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Work Mode Control -->
      <div class="card">
        <div class="card-header">
          <h2>‚ö° Work Mode</h2>
        </div>
        <div class="card-body">
          <form id="form-workMode" onsubmit="setWorkMode(event)">
            <div class="input-group">
              <label>Select Work Mode</label>
              <select name="workMode" class="input" required>
                <option value="">-- Select Mode --</option>
                <option value="SelfUse">Self Use</option>
                <option value="ForceCharge">Force Charge</option>
                <option value="ForceDischarge">Force Discharge</option>
                <option value="Feedin">Feed In</option>
                <option value="Backup">Backup</option>
              </select>
            </div>
            <div id="currentWorkMode" style="padding:10px;background:rgba(88,166,255,0.05);border-radius:6px;font-size:13px;color:var(--muted);margin-bottom:12px">
              Current mode: <span style="color:var(--accent)">Unknown</span>
            </div>
            <div id="status-workMode"></div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary" style="flex:1">‚úÖ Apply Mode</button>
              <button type="button" class="btn" onclick="getWorkMode()">üîÑ Check Current</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Force Charge Times -->
      <div class="card">
        <div class="card-header">
          <h2>‚è∞ Force Charge Times</h2>
        </div>
        <div class="card-body">
          <form id="form-forceCharge" onsubmit="setForceChargeTimes(event)">
            <div class="input-group">
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" name="enable1" style="width:auto">
                <span>Enable Period 1</span>
              </label>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Start Time 1</label>
                <input type="time" name="startTime1" class="input" value="00:00">
              </div>
              <div class="input-group">
                <label>End Time 1</label>
                <input type="time" name="endTime1" class="input" value="07:00">
              </div>
            </div>
            <div class="input-group">
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" name="enable2" style="width:auto">
                <span>Enable Period 2</span>
              </label>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Start Time 2</label>
                <input type="time" name="startTime2" class="input" value="00:00">
              </div>
              <div class="input-group">
                <label>End Time 2</label>
                <input type="time" name="endTime2" class="input" value="00:00">
              </div>
            </div>
            <div id="status-forceCharge"></div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary" style="flex:1">üíæ Save Times</button>
              <button type="button" class="btn" onclick="getForceChargeTimes()">üîÑ Load Current</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Scheduler Info -->
      <div class="card">
        <div class="card-header">
          <h2>üìÖ Scheduler Info</h2>
        </div>
        <div class="card-body">
          <div class="btn-grid">
            <button class="btn" onclick="callAPI('/api/scheduler/v1/get', 'Scheduler Data')">üìä Get Scheduler</button>
            <button class="btn" onclick="callAPI('/api/device/battery/forceChargeTime/get', 'Charge Times')">‚è∞ Charge Times</button>
            <button class="btn" onclick="callAPI('/api/device/workmode/get', 'Work Mode')">‚öôÔ∏è Work Mode</button>
          </div>
        </div>
      </div>

      <!-- Platform & Logger -->
      <div class="card">
        <div class="card-header">
          <h2>üõ†Ô∏è Platform & Logger</h2>
        </div>
        <div class="card-body">
          <div class="btn-grid">
            <button class="btn" onclick="callAPI('/api/platform/access-count', 'Access Count')">üìä Access Count</button>
            <button class="btn" onclick="callAPI('/api/module/signal', 'Module Signal')">üì° Signal</button>
            <button class="btn" onclick="callAPI('/api/plant/list', 'Plant List')">üè≠ Plants</button>
            <button class="btn" onclick="callAPI('/api/module/list', 'Module List')">üìã Modules</button>
          </div>
        </div>
      </div>

      <!-- EMS & Meter -->
      <div class="card">
        <div class="card-header">
          <h2>üå°Ô∏è EMS & Meter</h2>
        </div>
        <div class="card-body">
          <div class="btn-grid">
            <button class="btn" onclick="callAPI('/api/ems/list', 'EMS List')">üìã EMS List</button>
            <button class="btn" onclick="callAPI('/api/meter/list', 'Meter List')">‚ö° Meter List</button>
              <button class="btn" onclick="callAPIPost('/api/device/getMeterReader', 'Get Meter Reader', {}, true)">üîé Get Meter Reader</button>
          </div>
        </div>
      </div>

      <!-- Inverter Data -->
      <div class="card">
        <div class="card-header">
          <h2>‚ö° Inverter Data</h2>
        </div>
        <div class="card-body">
          <div class="btn-grid">
            <button class="btn" onclick="callAPI('/api/inverter/real-time', 'Real-time Data')">üìä Real-time</button>
            <button class="btn" onclick="callAPI('/api/inverter/battery-soc', 'Battery SoC')">üîã Battery</button>
            <button class="btn" onclick="callAPI('/api/inverter/generation', 'Generation')">‚òÄÔ∏è Generation</button>
            <button class="btn" onclick="callAPI('/api/inverter/temps', 'Temperatures')">üå°Ô∏è Temps</button>
          </div>
        </div>
      </div>

      <!-- View Settings Info (Read-Only) -->
      <div class="card">
        <div class="card-header">
          <h2>üîç View Device Settings</h2>
        </div>
        <div class="card-body">
          <div style="padding:10px;background:rgba(88,166,255,0.05);border-radius:6px;margin-bottom:12px;font-size:12px;color:#79c0ff;border:1px solid rgba(88,166,255,0.2)">
            ‚ÑπÔ∏è <strong>Read-only viewer</strong> - Query device settings without making changes. Use the forms above to modify settings.
          </div>
          <div class="input-group">
            <label>Select Setting to View</label>
            <select id="settingKey" class="input">
              <option value="MinSoc">MinSoc - Minimum State of Charge</option>
              <option value="MinSocOnGrid">MinSocOnGrid - Min SoC when on grid</option>
              <option value="MaxSoc">MaxSoc - Maximum State of Charge</option>
              <option value="workMode">workMode - Current work mode</option>
              <option value="pvPower">pvPower - PV Power setting</option>
              <option value="gridCharge">gridCharge - Grid charge enabled</option>
              <option value="forceChargeSOC">forceChargeSOC - Force charge SoC target</option>
              <option value="peakAndValley">peakAndValley - Peak/Valley mode</option>
              <option value="loadFirst">loadFirst - Load first priority</option>
              <option value="batteryFirst">batteryFirst - Battery first priority</option>
            </select>
          </div>
          <div class="form-actions">
            <button type="button" class="btn" onclick="getDeviceSetting()" style="flex:1">üëÅÔ∏è View Setting</button>
          </div>
        </div>
      </div>

    </div>

    <!-- Output Panel -->
    <div class="output-panel">
      <div class="output-header">
        <h2>üìã API Response</h2>
        <button class="btn" onclick="clearOutput()" style="padding:6px 10px;font-size:12px">üóëÔ∏è Clear</button>
      </div>
      <div class="output-body">
        <div id="output" class="output-content">Click any button above to see API responses here...</div>
      </div>
    </div>

    <!-- Topology Diagnostics Section -->
    <div class="card" style="margin-top: 20px;">
      <div class="card-header">
        <h2>üî¨ Solar Topology Diagnostics</h2>
      </div>
      <div class="card-body">
        <div class="hint">
          <strong>üîç For AC-Coupled Solar Users:</strong> If your solar panels connect to a separate inverter (not directly to Fox), 
          your setup is "AC-coupled". Fox may show this as "GEN LOAD" instead of "PV". Use these tools to identify which meter 
          channel represents your solar production.
        </div>

        <div style="display: grid; gap: 12px;">
          <!-- Discover Variables -->
          <div>
            <button type="button" class="btn" onclick="discoverVariables()" id="btnDiscoverVars" style="width: 100%;">
              üîç Discover Available Variables
            </button>
            <div id="status-discover" style="margin-top: 8px;"></div>
          </div>

          <!-- Get All Real-Time Data -->
          <div>
            <button type="button" class="btn" onclick="getAllRealtimeData()" id="btnAllData" style="width: 100%;">
              üìä Get All Real-Time Data (No Filters)
            </button>
            <div id="status-alldata" style="margin-top: 8px;"></div>
          </div>

          <!-- Topology Analysis Display -->
          <div id="topologyAnalysis" style="display: none; margin-top: 12px; padding: 12px; background: rgba(88, 166, 255, 0.08); border-left: 3px solid var(--accent-blue); border-radius: 6px;">
            <div style="font-size: 13px; font-weight: 600; color: var(--accent-blue); margin-bottom: 8px;">
              üì° Detected Topology
            </div>
            <div id="topologyResult" style="font-size: 12px; color: var(--text-secondary);"></div>
          </div>

          <!-- Instructions -->
          <details style="margin-top: 12px;">
            <summary style="cursor: pointer; font-size: 13px; font-weight: 600; color: var(--accent-blue); padding: 8px 0;">
              üìñ How to Use These Diagnostics
            </summary>
            <div style="font-size: 12px; color: var(--text-secondary); padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; margin-top: 8px; line-height: 1.6;">
              <p><strong>Step 1:</strong> Click "Discover Available Variables" to see what data your device exposes.</p>
              <p><strong>Step 2:</strong> During solar production hours (midday), click "Get All Real-Time Data".</p>
              <p><strong>Step 3:</strong> Check the "API Response" panel below for:</p>
              <ul style="margin-left: 20px;">
                <li><code>pvPower</code> - DC-coupled solar (normal setup)</li>
                <li><code>meterPower</code> and <code>meterPower2</code> - Meter channels (may be AC-coupled solar)</li>
                <li><code>batChargePower</code> - Battery charging rate</li>
                <li><code>gridConsumptionPower</code> - Grid import</li>
              </ul>
              <p><strong>Analysis:</strong> If <code>pvPower ‚âà 0</code> but battery is charging and no grid import, 
              energy comes from AC-coupled solar (check which <code>meterPower*</code> has positive value).</p>
              <p><strong>Next Step:</strong> Share the output with support to configure the correct solar source.</p>
            </div>
          </details>
        </div>
      </div>
    </div>

  </div>

  <!-- API Call Metrics Footer -->
  <div id="apiMetricsFooter" class="api-metrics-footer">
    <div class="metrics-icon">üìä API Calls</div>
    <div id="metricsDate" class="metrics-date">‚Äî</div>
    <div id="metricsCounts" class="metrics-counts">
      <div class="metric-fox">FoxESS: <span id="countFox" class="metric-value">0</span></div>
      <div class="metric-amber">Amber: <span id="countAmber" class="metric-value">0</span></div>
      <div class="metric-weather">Weather: <span id="countWeather" class="metric-value">0</span></div>
    </div>
    <button class="btn btn-sm" onclick="loadApiMetrics(1)" title="Refresh metrics">üîÑ</button>
  </div>

  <script>
    const output = document.getElementById('output');
    
    // apiClient is declared in api-client.js and initialized after Firebase auth is ready

    /**
     * Helper function to make authenticated API calls.
     * Uses apiClient.fetch to include the Authorization header and normalize responses.
     */
    async function authenticatedFetch(url, options = {}) {
      if (window.AppShell && typeof AppShell.authFetch === 'function') {
        return AppShell.authFetch(url, options);
      }
      try {
        if (typeof waitForAPIClient === 'function') {
          await waitForAPIClient(3000);
        } else {
          const start = Date.now();
          while (!apiClient && (Date.now() - start) < 3000) {
            await new Promise(r => setTimeout(r, 50));
          }
        }
      } catch (e) {
        console.warn('[API] apiClient not initialized yet');
        throw new Error('API client not ready');
      }
      return apiClient.fetch(url, options);
    }

    AppShell.init({
      pageName: 'controls',
      autoMetrics: true,
      onReady: () => {
        // Work mode loading disabled - user can fetch manually via "Check Current" button
      }
    });

    function showStatus(formId, message, type = 'info') {
      const statusEl = document.getElementById(`status-${formId}`);
      if (statusEl) {
        statusEl.innerHTML = `<div class="status-message ${type}">${message}</div>`;
        setTimeout(() => statusEl.innerHTML = '', 5000);
      }
    }

    function clearOutput() {
      output.innerHTML = '<div style="text-align:center;padding:40px;color:#8b949e;font-size:13px">üìã Output cleared. Click any button to see API responses...</div>';
    }

    function displayFormattedResponse(title, data) {
      const isSuccess = data.errno === 0;
      const statusColor = isSuccess ? '#7ee787' : '#ff7b72';
      const statusIcon = isSuccess ? '‚úÖ' : '‚ùå';
      
      let html = `<div style="border-bottom:1px solid rgba(48,54,61,0.6);padding-bottom:10px;margin-bottom:12px">`;
      html += `<div style="font-size:14px;font-weight:600;color:${statusColor};margin-bottom:4px">${statusIcon} ${title}</div>`;
      html += `<div style="font-size:11px;color:#8b949e">Status: ${data.errno === 0 ? 'Success' : 'Error'} ‚Ä¢ Code: ${data.errno}</div>`;
      html += `</div>`;
      
      if (data.msg) {
        html += `<div style="padding:8px;background:rgba(88,166,255,0.05);border-radius:6px;margin-bottom:10px;font-size:12px;color:#79c0ff">üìù ${data.msg}</div>`;
      }
      
      if (data.result) {
        html += `<div style="font-size:12px;font-weight:600;color:#8b949e;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Result Data:</div>`;
        html += `<div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;border:1px solid rgba(48,54,61,0.6)">`;
        
        if (typeof data.result === 'object' && !Array.isArray(data.result)) {
          for (const [key, value] of Object.entries(data.result)) {
            const displayValue = typeof value === 'object' ? JSON.stringify(value) : value;
            html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(48,54,61,0.3)">`;
            html += `<span style="color:#8b949e;font-size:12px">${key}:</span>`;
            html += `<span style="color:#7ee787;font-size:12px;font-weight:500">${displayValue}</span>`;
            html += `</div>`;
          }
        } else {
          html += `<pre style="margin:0;color:#7ee787;font-size:11px;white-space:pre-wrap">${JSON.stringify(data.result, null, 2)}</pre>`;
        }
        html += `</div>`;
      }
      
      html += `<details style="margin-top:12px;cursor:pointer">`;
      html += `<summary style="color:#8b949e;font-size:11px;padding:6px;background:rgba(0,0,0,0.2);border-radius:4px">üîç View Raw JSON</summary>`;
      html += `<pre style="margin:8px 0 0 0;padding:10px;background:#010409;border-radius:6px;font-size:11px;color:#7ee787;overflow:auto">${JSON.stringify(data, null, 2)}</pre>`;
      html += `</details>`;
      
      output.innerHTML = html;
    }

    async function callAPI(url, title = 'API Response') {
      output.innerHTML = `<div style="text-align:center;padding:20px;color:#79c0ff">‚è≥ Loading ${title}...</div>`;
      try {
        const res = await authenticatedFetch(url);
        const text = await res.text();
        let parsed;
        try {
          parsed = JSON.parse(text);
          displayFormattedResponse(title, parsed);
        } catch {
          output.innerHTML = `<div style="color:#ffd43b;padding:10px;background:rgba(255,212,59,0.1);border-radius:6px;border:1px solid rgba(255,212,59,0.3)">`;
          output.innerHTML += `<div style="font-weight:600;margin-bottom:8px">‚ö†Ô∏è Non-JSON Response</div>`;
          output.innerHTML += `<pre style="font-size:11px;white-space:pre-wrap;margin:0">${text}</pre>`;
          output.innerHTML += `</div>`;
        }
      } catch (e) {
        output.innerHTML = `<div style="color:#ff7b72;padding:10px;background:rgba(248,81,73,0.1);border-radius:6px;border:1px solid rgba(248,81,73,0.3)">`;
        output.innerHTML += `<div style="font-weight:600;margin-bottom:8px">‚ùå Error fetching ${title}</div>`;
        output.innerHTML += `<div style="font-size:12px">${e.message}</div>`;
        output.innerHTML += `</div>`;
      }
    }

    // POST helper for APIs that require a JSON body
    async function callAPIPost(endpoint, title = 'API Response', bodyTemplate = {}, autoOpen = false) {
      // optionally auto-open the right panel (not necessary in this page)
      output.innerHTML = `<div style="text-align:center;padding:20px;color:#79c0ff">‚è≥ Sending ${title}...</div>`;
      try {
        const res = await authenticatedFetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyTemplate)
        });
        const text = await res.text();
        try {
          const parsed = JSON.parse(text);
          displayFormattedResponse(title, parsed);
        } catch (e) {
          output.innerHTML = `<div style="color:#ffd43b;padding:10px;background:rgba(255,212,59,0.1);border-radius:6px;border:1px solid rgba(255,212,59,0.3)">`;
          output.innerHTML += `<div style="font-weight:600;margin-bottom:8px">‚ö†Ô∏è Non-JSON Response</div>`;
          output.innerHTML += `<pre style="font-size:11px;white-space:pre-wrap;margin:0">${text}</pre>`;
          output.innerHTML += `</div>`;
        }
      } catch (e) {
        output.innerHTML = `<div style="color:#ff7b72;padding:10px;background:rgba(248,81,73,0.1);border-radius:6px;border:1px solid rgba(248,81,73,0.3)">`;
        output.innerHTML += `<div style="font-weight:600;margin-bottom:8px">‚ùå Error sending ${title}</div>`;
        output.innerHTML += `<div style="font-size:12px">${e.message}</div>`;
        output.innerHTML += `</div>`;
      }
    }

    // Battery SoC Functions
    async function setBatterySoc(e) {
      e.preventDefault();
      const form = e.target;
      const minSoc = parseInt(form.minSoc.value);
      const minSocOnGrid = parseInt(form.minSocOnGrid.value);
      const maxSoc = parseInt(form.maxSoc.value);
      
      console.log('[BatterySoC] Saving settings: minSoc:', minSoc, 'minSocOnGrid:', minSocOnGrid, 'maxSoc:', maxSoc);
      showStatus('batterySoc', '‚è≥ Saving battery SoC settings...', 'info');
      
      try {
        // Step 1: Set minSoc and minSocOnGrid via battery/soc/set API
        console.log('[BatterySoC] Step 1: Setting minSoc and minSocOnGrid via /api/device/battery/soc/set');
        const res1 = await authenticatedFetch('/api/device/battery/soc/set', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ minSoc, minSocOnGrid })
        });
        const result1 = await res1.json();
        console.log('[BatterySoC] Battery SoC API response:', result1);
        
        if (result1.errno !== 0) {
          throw new Error(`Failed to set min SoC: ${result1.msg || 'Unknown error'}`);
        }
        
        // Step 2: Set maxSoc via device/setting/set API (MaxSoc is a device setting, not a battery/soc parameter)
        console.log('[BatterySoC] Step 2: Setting maxSoc via /api/device/setting/set with key="MaxSoc"');
        const res2 = await authenticatedFetch('/api/device/setting/set', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: 'MaxSoc', value: maxSoc })
        });
        const result2 = await res2.json();
        console.log('[BatterySoC] Device setting API response:', result2);
        
        if (result2.errno !== 0) {
          throw new Error(`Min SoC saved, but MaxSoc failed: ${result2.msg || 'Unknown error'}`);
        }
        
        console.log('[BatterySoC] ‚úÖ All settings saved successfully');
        showStatus('batterySoc', '‚úÖ Battery SoC settings saved successfully!', 'success');
        displayFormattedResponse('Battery SoC Settings (Combined)', {
          errno: 0,
          msg: 'All settings saved',
          batterySocResult: result1,
          maxSocResult: result2
        });
      } catch (error) {
        console.error('[BatterySoC] Error:', error);
        showStatus('batterySoc', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function getBatterySoc() {
      showStatus('batterySoc', '‚è≥ Loading current settings...', 'info');
      try {
        // Step 1: Get minSoc and minSocOnGrid from battery/soc/get
        console.log('[BatterySoC] Loading: Step 1 - Fetching battery/soc/get');
        const res1 = await authenticatedFetch('/api/device/battery/soc/get');
        const contentType = res1.headers.get('content-type');
        
        if (!res1.ok) {
          throw new Error(`HTTP ${res1.status}: ${res1.statusText}`);
        }
        
        let result1;
        if (contentType && contentType.includes('application/json')) {
          result1 = await res1.json();
        } else {
          const text = await res1.text();
          showStatus('batterySoc', `‚ùå Error: Server returned invalid response (${text.substring(0, 100)})`, 'error');
          return;
        }
        
        console.log('[BatterySoC] Battery SoC GET response:', result1);
        
        // Step 2: Get maxSoc from device setting (MaxSoc is a device setting)
        console.log('[BatterySoC] Loading: Step 2 - Fetching device/setting/get for MaxSoc');
        const res2 = await authenticatedFetch('/api/device/setting/get', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: 'MaxSoc' })
        });
        const result2 = await res2.json();
        console.log('[BatterySoC] MaxSoc device setting response:', result2);
        
        if (result1.errno === 0 && result1.result) {
          const form = document.getElementById('form-batterySoc');
          form.minSoc.value = result1.result.minSoc || 10;
          form.minSocOnGrid.value = result1.result.minSocOnGrid || 10;
          form.maxSoc.value = (result2.errno === 0 && result2.result?.value) ? result2.result.value : 90;
          
          console.log('[BatterySoC] ‚úÖ Loaded all settings successfully');
          showStatus('batterySoc', '‚úÖ Loaded current settings', 'success');
          displayFormattedResponse('Battery SoC Settings (Combined)', {
            errno: 0,
            msg: 'Settings loaded',
            batterySoc: result1.result,
            maxSoc: result2.result
          });
        } else {
          showStatus('batterySoc', `‚ùå ${result1.msg || 'Failed to load settings'}`, 'error');
        }
      } catch (error) {
        console.error('[BatterySoC] Load error:', error);
        showStatus('batterySoc', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Work Mode Functions
    async function setWorkMode(e) {
      e.preventDefault();
      const form = e.target;
      const workMode = form.workMode.value;
      
      if (!workMode) {
        showStatus('workMode', '‚ö†Ô∏è Please select a work mode', 'error');
        return;
      }
      
      showStatus('workMode', `‚è≥ Setting work mode to ${workMode}...`, 'info');
      
      try {
        const res = await authenticatedFetch('/api/inverter/mode/set', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ workMode })
        });
        const result = await res.json();
        
        if (result.errno === 0) {
          showStatus('workMode', `‚úÖ Work mode set to ${workMode} successfully!`, 'success');
          document.getElementById('currentWorkMode').innerHTML = `Current mode: <span style="color:#7ee787">${workMode}</span>`;
          displayFormattedResponse('Work Mode Setting', result);
        } else {
          showStatus('workMode', `‚ùå Error: ${result.msg || 'Failed to set work mode'}`, 'error');
          displayFormattedResponse('Work Mode Setting', result);
        }
      } catch (error) {
        showStatus('workMode', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function getWorkMode() {
      try {
        const res = await authenticatedFetch('/api/device/workmode/get');
        const result = await res.json();
        
        if (result.errno === 0 && result.result) {
          const currentMode = result.result.value;
          document.getElementById('currentWorkMode').innerHTML = `Current mode: <span style="color:#7ee787">${currentMode}</span>`;
          
          const select = document.querySelector('#form-workMode select[name="workMode"]');
          select.value = currentMode;
          
          showStatus('workMode', '‚úÖ Loaded current work mode', 'success');
          displayFormattedResponse('Work Mode Setting', result);
        } else {
          showStatus('workMode', `‚ùå ${result.msg || 'Failed to get work mode'}`, 'error');
          displayFormattedResponse('Work Mode Setting', result);
        }
      } catch (error) {
        showStatus('workMode', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Force Charge Times Functions
    async function setForceChargeTimes(e) {
      e.preventDefault();
      const form = e.target;
      
      const parseTime = (timeStr) => {
        const [hour, minute] = timeStr.split(':').map(Number);
        return { hour, minute };
      };
      
      const data = {
        enable1: form.enable1.checked,
        enable2: form.enable2.checked,
        startTime1: parseTime(form.startTime1.value),
        endTime1: parseTime(form.endTime1.value),
        startTime2: parseTime(form.startTime2.value),
        endTime2: parseTime(form.endTime2.value)
      };
      
      showStatus('forceCharge', '‚è≥ Saving force charge times...', 'info');
      
      try {
        const res = await authenticatedFetch('/api/device/battery/forceChargeTime/set', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        
        if (result.errno === 0) {
          showStatus('forceCharge', '‚úÖ Force charge times saved successfully!', 'success');
          displayFormattedResponse('Force Charge Times', result);
        } else {
          showStatus('forceCharge', `‚ùå Error: ${result.msg || 'Failed to save times'}`, 'error');
          displayFormattedResponse('Force Charge Times', result);
        }
      } catch (error) {
        showStatus('forceCharge', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function getForceChargeTimes() {
      try {
        const res = await authenticatedFetch('/api/device/battery/forceChargeTime/get');
        const result = await res.json();
        
        if (result.errno === 0 && result.result) {
          const form = document.getElementById('form-forceCharge');
          const data = result.result;
          
          form.enable1.checked = data.enable1 || false;
          form.enable2.checked = data.enable2 || false;
          
          const formatTime = (obj) => {
            const h = String(obj.hour || 0).padStart(2, '0');
            const m = String(obj.minute || 0).padStart(2, '0');
            return `${h}:${m}`;
          };
          
          form.startTime1.value = formatTime(data.startTime1 || {});
          form.endTime1.value = formatTime(data.endTime1 || {});
          form.startTime2.value = formatTime(data.startTime2 || {});
          form.endTime2.value = formatTime(data.endTime2 || {});
          
          showStatus('forceCharge', '‚úÖ Loaded current charge times', 'success');
          displayFormattedResponse('Force Charge Times', result);
        } else {
          showStatus('forceCharge', `‚ùå ${result.msg || 'Failed to load times'}`, 'error');
          displayFormattedResponse('Force Charge Times', result);
        }
      } catch (error) {
        showStatus('forceCharge', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    // Device Setting Query
    async function getDeviceSetting() {
      const key = document.getElementById('settingKey').value.trim();
      if (!key) {
        output.textContent = '‚ö†Ô∏è Please enter a setting key';
        output.style.color = '#ffd43b';
        return;
      }
      callAPI(`/api/inverter/settings?key=${encodeURIComponent(key)}`, `Setting: ${key}`);
    }

    // Load API metrics
    async function loadApiMetrics(days = 1) {
      try {
        // Use scope=user to show per-user metrics, not global platform totals
        const resp = await authenticatedFetch(`/api/metrics/api-calls?days=${encodeURIComponent(days)}&scope=user`);
        const data = await resp.json();
        if (!data || data.errno !== 0 || !data.result) return;
        const keys = Object.keys(data.result).sort().reverse();
        const todayKey = keys[0];
        const today = data.result[todayKey] || {};

        const dateObj = new Date(todayKey);
        const formatted = dateObj.toLocaleDateString('en-AU', { month: 'short', day: 'numeric', year: 'numeric' });
        document.getElementById('metricsDate').textContent = formatted;
        document.getElementById('countFox').textContent = today.foxess ?? 0;
        document.getElementById('countAmber').textContent = today.amber ?? 0;
        document.getElementById('countWeather').textContent = today.weather ?? 0;
      } catch (e) {
        console.warn('Failed to load api metrics', e.message);
      }
    }

    // ==================== DIAGNOSTICS FUNCTIONS ====================

    async function discoverVariables() {
      const btn = document.getElementById('btnDiscoverVars');
      const status = document.getElementById('status-discover');
      
      try {
        btn.disabled = true;
        btn.textContent = '‚è≥ Discovering...';
        status.innerHTML = '<div class="status-message info">Querying device variables...</div>';

        const resp = await authenticatedFetch('/api/inverter/discover-variables');
        const result = await resp.json();

        if (result.errno === 0) {
          status.innerHTML = '<div class="status-message success">‚úÖ Variables discovered! Check output panel below.</div>';
          displayFormattedResponse('Available Variables', result);
          
          // Show available variables count
          if (result.result && Array.isArray(result.result)) {
            const varCount = result.result.length;
            status.innerHTML = `<div class="status-message success">‚úÖ Found ${varCount} available variables</div>`;
          }
        } else {
          status.innerHTML = `<div class="status-message error">‚ùå ${result.error || 'Failed to discover variables'}</div>`;
          displayFormattedResponse('Discovery Error', result);
        }
      } catch (error) {
        status.innerHTML = `<div class="status-message error">‚ùå Error: ${error.message}</div>`;
        console.error('Discovery error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Discover Available Variables';
      }
    }

    async function getAllRealtimeData() {
      const btn = document.getElementById('btnAllData');
      const status = document.getElementById('status-alldata');
      const analysisDiv = document.getElementById('topologyAnalysis');
      const resultDiv = document.getElementById('topologyResult');
      
      try {
        btn.disabled = true;
        btn.textContent = '‚è≥ Querying...';
        status.innerHTML = '<div class="status-message info">Fetching all real-time data...</div>';

        console.log('[Diagnostics] Making request to /api/inverter/all-data');
        
        const resp = await authenticatedFetch('/api/inverter/all-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        console.log('[Diagnostics] Response status:', resp.status);
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        
        const result = await resp.json();
        console.log('[Diagnostics] Response data:', result);

        if (result.errno === 0) {
          status.innerHTML = '<div class="status-message success">‚úÖ Data retrieved! Check output and topology analysis below.</div>';
          displayFormattedResponse('All Real-Time Data', result);
          
          // Show topology analysis if available
          if (result.topologyHints) {
            analysisDiv.style.display = 'block';
            const hints = result.topologyHints;
            
            let html = `<div style="display: grid; gap: 8px; font-size: 12px;">`;
            html += `<div><strong>Detected Topology:</strong> <span style="color: var(--accent);">${hints.likelyTopology}</span></div>`;
            html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 4px;">`;
            html += `<div>pvPower: <strong>${hints.pvPower?.toFixed(2) || 0} kW</strong></div>`;
            html += `<div>batChargePower: <strong>${hints.batChargePower?.toFixed(2) || 0} kW</strong></div>`;
            if (hints.meterPower !== null) {
              html += `<div>meterPower: <strong>${hints.meterPower?.toFixed(2) || 0} kW</strong></div>`;
            }
            if (hints.meterPower2 !== null) {
              html += `<div>meterPower2: <strong>${hints.meterPower2?.toFixed(2) || 0} kW</strong></div>`;
            }
            html += `<div>gridConsumption: <strong>${hints.gridConsumptionPower?.toFixed(2) || 0} kW</strong></div>`;
            html += `</div></div>`;
            
            // Add interpretation
            if (hints.likelyTopology.includes('AC-coupled')) {
              html += `<div style="margin-top: 8px; padding: 8px; background: rgba(126, 231, 135, 0.1); border-radius: 4px; color: var(--accent);">`;
              html += `<strong>‚ö†Ô∏è AC-Coupled Solar Detected:</strong> Your solar appears to be on a separate inverter. `;
              if (hints.meterPower2 > 0.5) {
                html += `<code>meterPower2</code> likely represents your solar production (${hints.meterPower2.toFixed(2)} kW).`;
              } else if (hints.meterPower > 0.5) {
                html += `<code>meterPower</code> likely represents your solar production (${hints.meterPower.toFixed(2)} kW).`;
              }
              html += `</div>`;
            } else if (hints.likelyTopology.includes('Unknown')) {
              html += `<div style="margin-top: 8px; padding: 8px; background: rgba(255, 212, 59, 0.1); border-radius: 4px; color: #ffd43b;">`;
              html += `<strong>‚ÑπÔ∏è Run During Solar Hours:</strong> Test this during midday when solar is producing for accurate detection.`;
              html += `</div>`;
            }
            
            resultDiv.innerHTML = html;
          }
        } else {
          status.innerHTML = `<div class="status-message error">‚ùå ${result.error || 'Failed to get data'}</div>`;
          displayFormattedResponse('Query Error', result);
          analysisDiv.style.display = 'none';
        }
      } catch (error) {
        status.innerHTML = `<div class="status-message error">‚ùå Error: ${error.message}</div>`;
        console.error('All-data query error:', error);
        analysisDiv.style.display = 'none';
      } finally {
        btn.disabled = false;
        btn.textContent = 'üìä Get All Real-Time Data (No Filters)';
      }
    }

    // WIP Pages visibility - Tesla & Topology Discovery (admin only)
    if (typeof window.auth !== 'undefined' && window.auth) {
      window.auth.onAuthStateChanged((user) => {
        if (user && user.email === 'sardanapalos928@hotmail.com') {
          const teslaLink = document.getElementById('teslaNavLink');
          const topologyLink = document.getElementById('topologyNavLink');
          if (teslaLink) teslaLink.style.display = '';
          if (topologyLink) topologyLink.style.display = '';
        }
      });
    }

    // Initialize Firebase on page load
  </script>
</body>
</html>
