<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password - FoxESS Solar Dashboard</title>
  <link rel="stylesheet" href="css/shared-styles.css">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Roboto, 'Segoe UI', Arial; background:#071019; color: #e6edf3; display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .card { width: 420px; background: rgba(6,10,14,0.75); border-radius: 12px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); }
    h1 { margin: 0 0 8px; font-size:18px; }
    p { color: #8b949e; margin-top:0; }
    .form-group { margin-top: 12px; }
    input { width:100%; padding:12px 14px; border-radius:8px; border:1px solid rgba(48,54,61,0.8); background: rgba(13,17,23,0.6); color: #e6edf3; }
    .btn { margin-top:16px; width:100%; padding:12px; border-radius:8px; background:linear-gradient(135deg,#238636,#1a7f37); color:#fff; border:none; cursor:pointer; }
    .message { margin-top:12px; padding:10px; border-radius:8px; display:none; }
    .message.show { display:block; }
    .error { background: rgba(248,81,73,0.08); border:1px solid rgba(248,81,73,0.2); color:#f85149; }
    .success { background: rgba(35,134,54,0.08); border:1px solid rgba(35,134,54,0.12); color:#7ee787; }
    .small { font-size:12px; color:#8b949e; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Reset your password</h1>
    <p id="intro">Verifying link...</p>

    <div id="form" style="display:none">
      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" disabled />
      </div>
      <div class="form-group">
        <label for="password">New password</label>
        <input id="password" type="password" placeholder="At least 6 characters" />
      </div>
      <button id="submitBtn" class="btn">Set new password</button>
      <div id="msg" class="message"></div>
      <div class="small">After resetting, you will be redirected to the sign in page.</div>
    </div>

    <div id="fatal" style="display:none">
      <div id="fatalMsg" class="message error show"></div>
      <div class="small">If the link is expired or invalid, request a new reset from the sign-in page.</div>
      <div style="margin-top:12px"><a href="/login.html">‚Üê Back to sign in</a></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/firebase-auth.js"></script>
  <script>
    // Ensure firebaseAuth is initialized on this page (uses firebase-config.js)
    (async () => {
      try {
        if (window.firebaseAuth && !firebaseAuth.initialized) {
          await firebaseAuth.init(window.firebaseConfig || {}, { allowMock: true });
        }
      } catch (e) {
        console.warn('firebaseAuth init failed on reset page:', e && e.message ? e.message : e);
      }
    })();
  </script>
  <script>
    function qs(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    (async function () {
      const oobCode = qs('oobCode');
      const mode = qs('mode');

      const intro = document.getElementById('intro');
      const form = document.getElementById('form');
      const fatal = document.getElementById('fatal');
      const fatalMsg = document.getElementById('fatalMsg');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const submitBtn = document.getElementById('submitBtn');
      const msg = document.getElementById('msg');

      if (!oobCode || mode !== 'resetPassword') {
        intro.textContent = 'This page is for completing password resets.';
        fatalMsg.textContent = 'Missing or invalid password reset link.';
        form.style.display = 'none'; fatal.style.display = 'block';
        return;
      }

      // Wait for firebaseAuth to be ready
      const waitForAuthInit = () => new Promise((res) => {
        if (window.firebaseAuth && firebaseAuth.initialized) return res();
        const t = setInterval(() => {
          if (window.firebaseAuth && firebaseAuth.initialized) { clearInterval(t); res(); }
        }, 100);
        setTimeout(() => { clearInterval(t); res(); }, 5000);
      });

      await waitForAuthInit();

      // Verify the code and show the associated email
      intro.textContent = 'Verifying link...';
      const verify = await firebaseAuth.verifyPasswordResetCode(oobCode);
      if (!verify.success) {
        intro.textContent = 'Invalid or expired link';
        fatalMsg.textContent = verify.error || 'Invalid or expired password reset link.';
        form.style.display = 'none'; fatal.style.display = 'block';
        return;
      }

      emailInput.value = verify.email || '';
      intro.textContent = 'Enter a new password for the account below.';
      form.style.display = 'block'; fatal.style.display = 'none';

      function showMessage(text, type) {
        msg.textContent = text;
        msg.className = 'message show ' + (type === 'error' ? 'error' : 'success');
      }

      submitBtn.addEventListener('click', async () => {
        const newPassword = passwordInput.value || '';
        if (newPassword.length < 6) {
          showMessage('Password must be at least 6 characters', 'error');
          return;
        }
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';
        const res = await firebaseAuth.confirmPasswordReset(oobCode, newPassword);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Set new password';
        if (!res.success) {
          showMessage(res.error || 'Failed to reset password', 'error');
          return;
        }
        showMessage('Password updated successfully. Redirecting to sign in...', 'success');
        setTimeout(() => { window.location.href = '/login.html'; }, 1800);
      });
    })();
  </script>
</body>
</html>
