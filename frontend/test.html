<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation Testing - Dry Run Mode</title>
    <link rel="stylesheet" href="css/shared-styles.css" />
    <!-- Firebase SDK (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-auth.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/shared-utils.js"></script>
    <script src="js/app-shell.js"></script>
    <style>
        /* Page-specific styles */
        body {
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        h2 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        h2 .icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-primary);
        }
        header h1 { 
            font-size: 1.4rem; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        .badge {
            background: var(--accent-yellow);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .badge-safe {
            background: var(--success);
            color: #000;
        }
        .back-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { text-decoration: underline; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            position: relative;
            z-index: 1;
        }
        @media (max-width: 1200px) {
            .grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 800px) {
            .grid { grid-template-columns: 1fr; }
        }

        /* Form inputs */
        input, select, textarea {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 8px 10px;
            font-size: 0.9rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Mock Data Section */
        .sim-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            margin-bottom: 16px;
        }
        @media (min-width: 600px) {
            .sim-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 900px) {
            .sim-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .sim-field label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }
        .sim-field input {
            width: 100%;
            margin-bottom: 4px;
        }
        .sim-field .hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
            font-style: italic;
        }

        /* Presets */
        .presets {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 18px;
            margin-bottom: 18px;
            align-items: center;
        }
        .presets button {
            padding: 8px 14px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Rules Display */
        .rule-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 14px;
            border: 1px solid rgba(48, 54, 61, 0.6);
            border-left: 4px solid #58a6ff;
        }
        .rule-card.disabled { 
            opacity: 0.6; 
            border-left-color: #6e7681;
        }
        .rule-card.triggered {
            border-left-color: #7ee787;
            background: rgba(126, 231, 135, 0.1);
        }
        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.4);
        }
        .rule-name { font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 10px; }
        .rule-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .rule-status.enabled { background: #1f6feb; color: #fff; }
        .rule-status.disabled { background: #6e7681; color: #fff; }
        .rule-params {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.85rem;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
        }
        .rule-param {
            background: rgba(88, 166, 255, 0.12);
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #58a6ff;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .rule-param .label { color: #58a6ff; font-weight: 600; font-size: 0.75rem; }
        .rule-param .value { font-weight: 600; color: #79c0ff; font-size: 0.85rem; }
        
        .cond-badge {
            display: inline-block;
            padding: 3px 6px;
            background: var(--bg-card);
            border: 1px solid var(--accent-blue);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--accent-blue);
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        /* Priority Badge */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-yellow);
            color: #000;
            font-weight: 700;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            min-width: 24px;
        }
        .priority-badge.p1 { background: #ff6b6b; color: #fff; } /* High priority - Red */
        .priority-badge.p2 { background: #ff922b; color: #000; } /* Medium-high - Orange */
        .priority-badge.p3 { background: #ffd43b; color: #000; } /* Medium - Yellow */
        .priority-badge.p4, .priority-badge.p5 { background: #51cf66; color: #000; } /* Lower - Green */
        .priority-badge.p-low { background: var(--text-secondary); color: #000; } /* Very low */

        /* Scheduler Mock */
        .scheduler-segment {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }
        .scheduler-segment.pending {
            border-color: var(--accent-yellow);
            background: rgba(210, 153, 34, 0.1);
        }
        .scheduler-segment .time-bar {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            margin: 8px 0;
            position: relative;
            overflow: hidden;
        }
        .scheduler-segment .time-bar .fill {
            position: absolute;
            height: 100%;
            background: var(--accent-blue);
            border-radius: 3px;
        }
        .segment-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .segment-mode {
            font-weight: 600;
            color: var(--accent);
        }

        /* Test Results */
        .result-box {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 14px;
            margin-top: 12px;
        }
        .result-box.triggered {
            border: 2px solid var(--accent);
            background: rgba(126, 231, 135, 0.1);
        }
        .result-box.not-triggered {
            border: 2px solid var(--accent-yellow);
            background: rgba(210, 153, 34, 0.1);
        }
        .result-box.error {
            border: 2px solid var(--accent-red);
            background: rgba(248, 81, 73, 0.1);
        }
        .result-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
        }

        /* Condition Highlight Styles */
        .condition-met {
            background: rgba(126, 231, 135, 0.15);
            border-left: 3px solid #7ee787;
        }
        .condition-not-met {
            background: rgba(248, 81, 73, 0.15);
            border-left: 3px solid #f85149;
        }
        .condition-blocked {
            background: rgba(240, 136, 62, 0.15);
            border-left: 3px solid #f0883e;
        }

        /* Rule Card Highlighting */
        .rule-triggered-card {
            background: rgba(126, 231, 135, 0.1);
            border: 2px solid #7ee787;
        }
        .rule-blocked-card {
            background: rgba(240, 136, 62, 0.1);
            border: 2px solid #f0883e;
        }
        .rule-not-met-card {
            background: rgba(248, 81, 73, 0.1);
            border: 2px solid #f85149;

        /* Log Output */
        .log-area {
            background: #010409;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #21262d;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #6e7681; }
        .log-info { color: var(--accent-blue); }
        .log-warn { color: var(--accent-yellow); }
        .log-success { color: var(--accent); }
        .log-error { color: var(--accent-red); }

        /* Run Button */
        .run-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            margin-top: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .full-width { grid-column: 1 / -1; }
        .span-2 { grid-column: span 2; }
        
        .info-banner {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 12px;
            line-height: 1.5;
        }
        .info-banner .icon { font-size: 1.3rem; flex-shrink: 0; }

        /* Modal - all positioning handled via JavaScript inline styles */
        .modal-overlay {
            display: none;
        }
        .modal-content {
            background: linear-gradient(145deg, #21262d, #161b22);
            border: 1px solid rgba(48, 54, 61, 0.8);
            border-radius: 16px;
            width: calc(100vw - 80px) !important;
            max-width: 1200px !important;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 24px;
        }

        /* Prevent body scroll while modal open */
        body.modal-open {
            overflow: hidden;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* API Payload Display */
        .api-payload {
            background: #010409;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            white-space: pre-wrap;
            color: var(--accent);
            max-height: 200px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }
        .empty-state .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* FAQ Section */
        .faq-section {
            margin-top: 20px;
        }
        .faq-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .faq-question:hover {
            background: var(--bg-card);
        }
        .faq-question .icon {
            transition: transform 0.2s;
            font-size: 0.8rem;
        }
        .faq-item.open .faq-question .icon {
            transform: rotate(180deg);
        }
        .faq-answer {
            display: none;
            padding: 0 16px 16px;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        .faq-item.open .faq-answer {
            display: block;
        }
        .faq-answer code {
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            color: var(--accent-blue);
        }
        .faq-answer ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .faq-answer li {
            margin-bottom: 6px;
        }
        .faq-highlight {
            background: rgba(126, 231, 135, 0.15);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid var(--accent);
        }

        .rule-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        .rule-actions button {
            padding: 5px 10px;
            font-size: 0.7rem;
            border-radius: 4px;
            background: rgba(88, 166, 255, 0.15);
            border: 1px solid #58a6ff;
            color: #79c0ff;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rule-actions button:hover {
            background: rgba(88, 166, 255, 0.25);
            border-color: #79c0ff;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="nav-main">
        <div class="nav-links">
            <a href="/" class="nav-link">üè† Overview</a>
            <a href="/test.html" class="nav-link">üß™ Automation Lab</a>
            <a href="/control.html" class="nav-link">üß≠ Controls</a>
            <a href="/history.html" class="nav-link">üìä History</a>
            <a href="/settings.html" class="nav-link">‚öôÔ∏è Settings</a>
        </div>
        <div class="nav-right">
            <span class="nav-info">Simulation mode</span>
            <div class="user-menu" data-user-menu>
                <button class="user-avatar" type="button" data-user-avatar>
                    <span data-user-initials>?</span>
                </button>
                <div class="user-dropdown" data-user-dropdown>
                    <div class="user-dropdown-header">
                        <div class="user-name" data-user-name>Guest</div>
                        <div class="user-email" data-user-email>Not signed in</div>
                    </div>
                    <button class="user-dropdown-item" type="button" data-go-settings>‚öôÔ∏è Settings</button>
                    <button class="user-dropdown-item danger" type="button" data-signout>üö™ Sign Out</button>
                </div>
            </div>
        </div>
    </nav>

    <div id="apiMetricsFooter" class="api-metrics-footer">
        <div class="metrics-icon">üìä API Calls</div>
        <div id="metricsDate" class="metrics-date">‚Äî</div>
        <div id="metricsCounts" class="metrics-counts">
            <div class="metric-fox">Fox: <span id="countFox" class="metric-value">0</span></div>
            <div class="metric-amber">Amber: <span id="countAmber" class="metric-value">0</span></div>
            <div class="metric-weather">Weather: <span id="countWeather" class="metric-value">0</span></div>
        </div>
        <button class="btn btn-sm" onclick="loadApiMetrics(1)" title="Refresh metrics">üîÑ</button>
    </div>

    <div class="container">
        <header>
            <h1>
                üß™ Automation Test Lab
                <span class="badge">DRY RUN</span>
                <span class="badge badge-safe">SAFE MODE</span>
            </h1>
            <a href="/" class="back-link">‚Üê Back to Dashboard</a>
        </header>

        <div class="info-banner">
            <span class="icon">üõ°Ô∏è</span>
            <div>
                <strong>Safe Testing Environment:</strong> All tests run in simulation mode. 
                No commands will be sent to your inverter. Test rules and see exactly what would happen.
            </div>
        </div>

        <div class="grid">
            <!-- Column 1: Mock Data Input -->
            <div class="card">
                <h2 style="text-align: center;">Simulated Conditions</h2>
                <div class="sim-grid">
                    <div class="sim-field">
                        <label>üí∞ Feed-in Price (¬¢/kWh)</label>
                        <input type="number" id="simFeedIn" value="25" min="-100" max="500" step="0.5">
                        <div class="hint">What you earn exporting</div>
                    </div>
                    <div class="sim-field">
                        <label>üì• Buy Price (¬¢/kWh)</label>
                        <input type="number" id="simBuy" value="30" min="-100" max="500" step="0.5">
                        <div class="hint">Cost to import</div>
                    </div>
                    <div class="sim-field">
                        <label>üîã Battery SoC (%)</label>
                        <input type="number" id="simSoC" value="75" min="0" max="100">
                    </div>
                    <div class="sim-field">
                        <label>üå°Ô∏è Battery Temp (¬∞C)</label>
                        <input type="number" id="simBatteryTemp" value="28" min="-40" max="80" step="0.5">
                    </div>
                    <div class="sim-field">
                        <label>üåç Ambient Temp (¬∞C)</label>
                        <input type="number" id="simAmbientTemp" value="22" min="-40" max="80" step="0.5">
                    </div>
                    <div class="sim-field">
                        <label>‚öôÔ∏è Inverter Temp (¬∞C)</label>
                        <input type="number" id="simInverterTemp" value="35" min="-40" max="80" step="0.5">
                    </div>
                    <div class="sim-field">
                        <label>üïê Simulated Time</label>
                        <input type="time" id="simTime" value="">
                    </div>
                    <div class="sim-field">
                        <label>‚òÄÔ∏è Solar Radiation (W/m¬≤)</label>
                        <input type="number" id="simSolarRadiation" value="500" min="0" max="1500" step="10">
                        <div class="hint">Current/forecast sunlight</div>
                    </div>
                    <div class="sim-field">
                        <label>‚òÅÔ∏è Cloud Cover (%)</label>
                        <input type="number" id="simCloudCover" value="25" min="0" max="100">
                        <div class="hint">0=clear, 100=overcast</div>
                    </div>
                    <div class="sim-field">
                        <label>üìä Forecast High Price (¬¢)</label>
                        <input type="number" id="simForecastHigh" value="50" min="-100" max="500" step="0.5">
                        <div class="hint">Max upcoming price</div>
                    </div>
                </div>
                
                <div class="presets">
                    <span style="font-size:0.75rem;color:var(--text-secondary);margin-right:6px">Presets:</span>
                    <button class="btn-secondary" onclick="loadPreset('highFeedIn')">High Export üí∞</button>
                    <button class="btn-secondary" onclick="loadPreset('cheapBuy')">Cheap Import üìâ</button>
                    <button class="btn-secondary" onclick="loadPreset('spike')">Price Spike ‚ö°</button>
                    <button class="btn-secondary" onclick="loadPreset('lowSoc')">Low Battery üîã</button>
                    <button class="btn-secondary" onclick="loadPreset('hotBattery')">Hot Battery üî•</button>
                    <button class="btn-secondary" onclick="loadPreset('cloudyDay')">Cloudy Day ‚òÅÔ∏è</button>
                    <button class="btn-secondary" onclick="loadPreset('sunnyPeak')">Sunny Peak ‚òÄÔ∏è</button>
                </div>
                
                <button class="btn-secondary run-btn" onclick="fetchRealConditions(); return false;" style="margin-bottom:10px;background:rgba(88,166,255,0.15);border-color:var(--accent-blue)">
                    üì° Fetch Real Conditions
                </button>
                <button class="btn-primary run-btn" onclick="runTest()">
                    üöÄ Run Automation Test
                </button>
            </div>

            <!-- Column 2: Rules -->
            <div class="card">
                <h2>
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Automation Rules</span>
                    <button class="btn btn-primary btn-sm" onclick="showAddRuleModal()" style="margin-left:auto;padding:8px 16px;font-size:0.85rem">‚ûï Add Rule</button>
                </h2>
                <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:14px;margin-bottom:16px;padding:8px 12px;background:rgba(88,166,255,0.1);border-radius:4px;border-left:3px solid #58a6ff">
                    üìã Sorted by priority ‚Ä¢ Lower number = Higher priority ‚Ä¢ First match wins
                </div>
                <div id="rulesDisplay">
                    <div class="empty-state">
                        <div class="icon">üìã</div>
                        <p>Loading rules...</p>
                    </div>
                </div>
                <button class="btn-secondary" style="width:100%;margin-top:10px" onclick="loadRules()">üîÑ Refresh</button>
            </div>

            <!-- Column 3: Mock Scheduler -->
            <div class="card">
                <h2><span class="icon">üìÖ</span> Mock Inverter Scheduler</h2>
                <p style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:12px">
                    Shows what scheduler segments would be created
                </p>
                <div id="mockScheduler">
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>No pending segments</p>
                        <p style="font-size:0.75rem">Run a test to see what would be scheduled</p>
                    </div>
                </div>
                <button class="btn-secondary" style="width:100%;margin-top:10px" onclick="clearMockScheduler()">üóëÔ∏è Clear Mock Segments</button>
            </div>

            <!-- Test Results -->
            <div class="card span-2">
                <h2><span class="icon">üìã</span> Test Results</h2>
                <div id="testResults">
                    <div class="empty-state">
                        <div class="icon">üî¨</div>
                        <p>Run a test to see results</p>
                    </div>
                </div>
            </div>

            <!-- API Payload Preview -->
            <div class="card">
                <h2><span class="icon">üì°</span> API Payload Preview</h2>
                <p style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px">
                    What would be sent to FoxESS API
                </p>
                <div class="api-payload" id="apiPayload">
// Run a test to see the API payload that would be sent
                </div>
            </div>

            <!-- Logs -->
            <div class="card full-width">
                <h2><span class="icon">üìú</span> Test Log</h2>
                <div class="log-area" id="logArea">
                    <div class="log-entry"><span class="log-time">[Ready]</span> <span class="log-info">Test lab initialized. Configure mock data and run tests.</span></div>
                </div>
            </div>

            <!-- FAQ Section -->
            <div class="card full-width">
                <h2><span class="icon">‚ùì</span> Automation FAQ</h2>
                <div class="faq-section" id="faqContainer">
                    <!-- FAQ items are rendered from the `automationFaq` config in the script. -->
                </div>
            </div>
        </div>
    </div>

    <!-- Static Rule Modal (populated dynamically, shown/hidden via class) -->
    <div class="modal-overlay" id="ruleModal" onclick="if(event.target===this) closeRuleModal()">
        <div class="modal-content" id="ruleModalContent">
            <!-- Content populated by showAddRuleModal() -->
        </div>
    </div>

    <script>
        // apiClient is declared in api-client.js and initialized after Firebase auth is ready

        /**
         * Helper function to make authenticated API calls.
         * Uses apiClient.fetch to include the Authorization header and normalize responses.
         */
        async function authenticatedFetch(url, options = {}) {
            if (window.AppShell && typeof AppShell.authFetch === 'function') {
                return AppShell.authFetch(url, options);
            }
            try {
                if (typeof waitForAPIClient === 'function') {
                    await waitForAPIClient(3000);
                } else {
                    const start = Date.now();
                    while (!apiClient && (Date.now() - start) < 3000) {
                        await new Promise(r => setTimeout(r, 50));
                    }
                }
            } catch (e) {
                console.warn('[API] apiClient not initialized yet');
                throw new Error('API client not ready');
            }
            return apiClient.fetch(url, options);
        }

        AppShell.init({
            pageName: 'automation-lab',
            autoMetrics: true,
            onReady: () => {
                try {
                    loadRules();
                } catch (error) {
                    console.warn('[Automation Lab] Failed to load rules', error);
                }
            }
        });

        // FAQ toggle
        function toggleFaq(element) {
            const item = element.parentElement;
            item.classList.toggle('open');
        }

        // FAQ content driven from configuration
        const automationFaq = [
            {
                question: 'How often does automation check conditions?',
                answer: `The automation engine runs every <code>60 seconds</code>. Each cycle it uses <strong>cached data</strong> from:
                    <ul>
                        <li><strong>Amber prices:</strong> refreshed every 60 seconds</li>
                        <li><strong>Inverter data (SoC, temps):</strong> refreshed every 5 minutes (respects FoxESS rate limits)</li>
                        <li><strong>Weather:</strong> refreshed every 30 minutes</li>
                    </ul>
                    <div class="faq-highlight">
                        The automation does NOT poll the inverter every 60 seconds ‚Äì it reuses the same data cache as the main UI to avoid excessive API calls.
                    </div>`
            },
            {
                question: 'What is the cooldown and why does it exist?',
                answer: `Each rule has a <code>cooldown</code> period (default: 5 minutes). After a rule triggers, it cannot trigger again until the cooldown expires.
                    <div class="faq-highlight"><strong>Why?</strong> Prevents "flapping" ‚Äì rapidly switching modes when values hover near thresholds. For example, if SoC bounces between 29% and 31%, you don't want to switch modes every 60 seconds.</div>`
            },
            {
                question: 'What happens if conditions change after a rule triggers?',
                answer: `<div class="faq-highlight"><strong>Active Cancellation:</strong> Rules are monitored continuously. If the triggering rule's conditions are no longer met, the scheduled segment is cancelled immediately (within ~30 seconds).</div>
                    <strong>Example:</strong>
                    <ul>
                        <li>Price drops below 10¬¢ ‚Üí "Charge Battery" rule triggers for 30 minutes</li>
                        <li>5 minutes later, price spikes back up to 40¬¢</li>
                        <li>Within 30 seconds, system detects conditions changed ‚Üí <em>cancels the charging segment</em></li>
                        <li>A different rule (e.g., "High Export Price") may then take over</li>
                    </ul>
                    <div class="faq-highlight"><strong>Priority Override:</strong> If a higher-priority rule's conditions are met while a lower-priority rule is active, the higher-priority rule <em>immediately replaces</em> the active segment (bypasses cooldown).</div>
                    This prevents wasteful operations when market conditions change rapidly.`
            },
            {
                question: 'How does priority work?',
                answer: `<ul>
                        <li><strong>Lower number = Higher priority</strong> (Priority 1 beats Priority 5)</li>
                        <li>Rules are evaluated in priority order</li>
                        <li><strong>First match wins</strong> ‚Äì once a rule's conditions are met, no lower-priority rules are checked</li>
                        <li>Use high priority (1-2) for safety rules (e.g., hot battery protection)</li>
                        <li>Use lower priority (3-5) for optimization rules (e.g., price arbitrage)</li>
                    </ul>
                    <div class="faq-highlight">üí° <strong>Tip:</strong> Color-coded badges show priority at a glance: üî¥ Red = 1, üü† Orange = 2, üü° Yellow = 3, üü¢ Green = 4-5</div>`
            },
            {
                question: 'What is "duration" in the action?',
                answer: `Duration sets how long the inverter scheduler segment should last (default: 30 minutes).
                    <ul>
                        <li>A triggered rule creates a time-bound segment (e.g., 10:00‚Äì10:30)</li>
                        <li>After the segment ends, the inverter reverts to its base schedule</li>
                        <li>However, if conditions are still met, the rule will re-trigger (after cooldown)</li>
                    </ul>
                    <strong>Note:</strong> Due to Active Cancellation, segments may end early if conditions change.`
            },
            {
                question: 'What conditions can I use?',
                answer: `<ul>
                        <li><code>feedInPrice</code> ‚Äì Amber feed-in price (¬¢/kWh) with operators &gt;, &lt;, or <em>between</em></li>
                        <li><code>buyPrice</code> ‚Äì Amber import price (¬¢/kWh) with operators &gt;, &lt;, or <em>between</em></li>
                        <li><code>batterySoC</code> ‚Äì Battery state of charge (%) with operators &gt;, &lt;, or <em>between</em></li>
                        <li><code>temperature</code> ‚Äì Battery, Ambient, or Inverter temperature (¬∞C)</li>
                        <li><code>solarRadiation</code> ‚Äì Forecasted solar radiation (W/m¬≤) - avg/min/max</li>
                        <li><code>cloudCover</code> ‚Äì Forecasted cloud cover (%) - avg/min/max</li>
                        <li><code>forecastPrice</code> ‚Äì Upcoming Amber prices with lookAhead period</li>
                        <li><code>timeWindow</code> ‚Äì Time of day range (e.g., 14:00-18:00)</li>
                    </ul>
                    <div class="faq-highlight">üí° All specified conditions must be met (AND logic) for the rule to trigger.</div>`
            },
            {
                question: 'What are the weather-based conditions?',
                answer: `<strong>Solar Radiation (‚òÄÔ∏è)</strong>
                    <ul>
                        <li>Measures expected sunlight intensity in W/m¬≤</li>
                        <li>High values (800+) = sunny day, great for solar generation</li>
                        <li>Low values (&lt;200) = cloudy/overcast, limited solar</li>
                        <li>Use to charge battery when solar production will be low</li>
                    </ul>
                    <strong>Cloud Cover (‚òÅÔ∏è)</strong>
                    <ul>
                        <li>Percentage of sky covered by clouds (0-100%)</li>
                        <li>0% = clear sky, 100% = completely overcast</li>
                        <li>Combine with solar radiation for weather-aware rules</li>
                    </ul>
                    <div class="faq-highlight">üí° <strong>Example:</strong> "If cloud cover &gt; 80% AND solar &lt; 150 W/m¬≤, charge from grid during cheap periods"</div>`
            },
            {
                question: 'How does forecast price work?',
                answer: `The <strong>Forecast Price</strong> condition checks upcoming Amber prices:
                    <ul>
                        <li><strong>Type:</strong> Feed-in (export) or Buy (import) prices</li>
                        <li><strong>Check:</strong> Average, Min, Max, or Any value in the period</li>
                        <li><strong>LookAhead:</strong> How far ahead to check (minutes/hours/days)</li>
                    </ul>
                    <strong>Use Cases:</strong>
                    <ul>
                        <li>Charge battery now if prices will spike in the next 2 hours</li>
                        <li>Hold charge if high feed-in prices are coming</li>
                        <li>Discharge before cheap import prices arrive</li>
                    </ul>
                    <div class="faq-highlight">üí° This lets you make proactive decisions based on upcoming market conditions rather than just reacting to current prices.</div>`
            }
        ];

        function renderFaq() {
            const container = document.getElementById('faqContainer');
            if (!container) return;
            let html = '';
            automationFaq.forEach((item, idx) => {
                html += `<div class="faq-item ${idx === 0 ? 'open' : ''}">` +
                        `<div class="faq-question" onclick="toggleFaq(this)"><span>${item.question}</span><span class="icon">‚ñº</span></div>` +
                        `<div class="faq-answer">${item.answer}</div>` +
                        `</div>`;
            });
            container.innerHTML = html;
        }

        // Render the FAQ from the config
        renderFaq();

        // State
        let mockSchedulerSegments = [];
        let currentRules = {};
        
        // Initialize time to now
        document.getElementById('simTime').value = new Date().toTimeString().slice(0,5);

        // Presets
        const presets = {
            highFeedIn: { feedIn: 40, buy: 25, soc: 85, batteryTemp: 28, ambientTemp: 22, inverterTemp: 35, solarRadiation: 600, cloudCover: 20, forecastHigh: 50 },
            cheapBuy: { feedIn: 8, buy: 5, soc: 30, batteryTemp: 25, ambientTemp: 20, inverterTemp: 32, solarRadiation: 300, cloudCover: 40, forecastHigh: 15 },
            spike: { feedIn: 150, buy: 180, soc: 70, batteryTemp: 32, ambientTemp: 25, inverterTemp: 38, solarRadiation: 500, cloudCover: 30, forecastHigh: 200 },
            lowSoc: { feedIn: 15, buy: 35, soc: 18, batteryTemp: 26, ambientTemp: 22, inverterTemp: 34, solarRadiation: 400, cloudCover: 35, forecastHigh: 40 },
            hotBattery: { feedIn: 20, buy: 30, soc: 60, batteryTemp: 48, ambientTemp: 35, inverterTemp: 52, solarRadiation: 800, cloudCover: 10, forecastHigh: 35 },
            cloudyDay: { feedIn: 5, buy: 25, soc: 45, batteryTemp: 22, ambientTemp: 18, inverterTemp: 28, solarRadiation: 80, cloudCover: 90, forecastHigh: 30 },
            sunnyPeak: { feedIn: 35, buy: 20, soc: 90, batteryTemp: 30, ambientTemp: 28, inverterTemp: 40, solarRadiation: 1100, cloudCover: 5, forecastHigh: 45 }
        };

        function loadPreset(name) {
            const p = presets[name];
            if (!p) return;
            document.getElementById('simFeedIn').value = p.feedIn;
            document.getElementById('simBuy').value = p.buy;
            document.getElementById('simSoC').value = p.soc;
            document.getElementById('simBatteryTemp').value = p.batteryTemp;
            document.getElementById('simAmbientTemp').value = p.ambientTemp;
            document.getElementById('simInverterTemp').value = p.inverterTemp;
            document.getElementById('simSolarRadiation').value = p.solarRadiation;
            document.getElementById('simCloudCover').value = p.cloudCover;
            document.getElementById('simForecastHigh').value = p.forecastHigh;
            log('info', `Loaded preset: ${name}`);
        }

        async function fetchRealConditions() {
            console.log('[DEBUG] fetchRealConditions called');
            log('info', 'üì¶ Loading conditions from cache (may fetch live data if cache empty)...');
            
            try {
                let updated = [];
                let hasInverterCache = false;
                let hasAmberCache = false;
                let hasWeatherCache = false;
                
                // Try to get cached prices from localStorage
                const cachedPrices = localStorage.getItem('cachedPrices');
                if (cachedPrices) {
                    try {
                        const prices = JSON.parse(cachedPrices);
                        if (prices.general?.perKwh !== undefined) {
                            document.getElementById('simBuy').value = prices.general.perKwh.toFixed(1);
                            updated.push('Buy price');
                            hasAmberCache = true;
                        }
                        if (prices.feedIn?.perKwh !== undefined) {
                            document.getElementById('simFeedIn').value = prices.feedIn.perKwh.toFixed(1);  // Already negated when cached
                            updated.push('Feed-in price');
                            hasAmberCache = true;
                        }
                        if (prices.forecastHigh !== undefined) {
                            document.getElementById('simForecastHigh').value = prices.forecastHigh.toFixed(1);
                            updated.push('Forecast high');
                            hasAmberCache = true;
                        }
                    } catch (e) { 
                        log('warning', `Parse error on prices: ${e.message}`);
                    }
                }
                
                // Try to get cached inverter data from localStorage
                const cachedInverter = localStorage.getItem('cachedInverter');
                if (cachedInverter) {
                    try {
                        const inv = JSON.parse(cachedInverter);
                        if (inv.SoC !== undefined) {
                            document.getElementById('simSoC').value = inv.SoC;
                            updated.push('SoC');
                            hasInverterCache = true;
                        }
                        if (inv.batTemperature !== undefined) {
                            document.getElementById('simBatteryTemp').value = inv.batTemperature.toFixed(1);
                            updated.push('Battery temp');
                            hasInverterCache = true;
                        }
                        if (inv.ambientTemperation !== undefined) {
                            document.getElementById('simAmbientTemp').value = inv.ambientTemperation.toFixed(1);
                            updated.push('Ambient temp');
                            hasInverterCache = true;
                        }
                        if (inv.invTemperation !== undefined) {
                            document.getElementById('simInverterTemp').value = inv.invTemperation.toFixed(1);
                            updated.push('Inverter temp');
                            hasInverterCache = true;
                        }
                    } catch (e) { 
                        log('warning', `Parse error on inverter: ${e.message}`);
                    }
                }
                
                // Try to get cached weather from localStorage
                const cachedWeather = localStorage.getItem('cachedWeather');
                if (cachedWeather) {
                    try {
                        const wx = JSON.parse(cachedWeather);
                        if (wx.solarRadiation !== undefined) {
                            document.getElementById('simSolarRadiation').value = wx.solarRadiation;
                            updated.push('Solar radiation');
                            hasWeatherCache = true;
                        }
                        if (wx.cloudCover !== undefined) {
                            document.getElementById('simCloudCover').value = wx.cloudCover;
                            updated.push('Cloud cover');
                            hasWeatherCache = true;
                        }
                    } catch (e) { 
                        log('warning', `Parse error on weather: ${e.message}`);
                    }
                }
                
                // Always set time to current
                const now = new Date();
                document.getElementById('simTime').value = now.toTimeString().slice(0, 5);
                updated.push('Time');
                
                if (hasInverterCache && hasAmberCache && hasWeatherCache) {
                    log('success', `‚úÖ Loaded from cache: ${updated.join(', ')}`);
                } else {
                    const missing = [];
                    if (!hasAmberCache) missing.push('Amber prices');
                    if (!hasWeatherCache) missing.push('Weather');
                    log('info', `üìã Cache missing: ${missing.join(', ')}. Attempting to fetch live data...`);
                    console.log('[DEBUG] Calling fetchLiveConditionsOnce, missing:', missing);
                    await fetchLiveConditionsOnce();
                }
            } catch (e) {
                log('error', `‚ùå Error: ${e.message}`);
                console.error('fetchRealConditions error:', e);
            }
        }
        
        async function fetchLiveConditionsOnce() {
            try {
                let updated = [];
                
                // Get user config for siteId
                let userConfig = null;
                try {
                    const configResp = await authenticatedFetch('/api/user/config');
                    if (configResp.ok) {
                        const configData = await configResp.json();
                        if (configData.errno === 0 && configData.result) {
                            userConfig = configData.result;
                        }
                    }
                } catch (e) { /* ignore */ }
                
                // Fetch inverter data
                try {
                    const invResp = await authenticatedFetch('/api/inverter/real-time');
                    if (invResp.ok) {
                        const invData = await invResp.json();
                        if (invData.errno === 0 && invData.result) {
                            const r = invData.result;
                            const items = [];
                            if (Array.isArray(r) && r.length > 0 && Array.isArray(r[0].datas)) {
                                r.forEach(frame => { if (Array.isArray(frame.datas)) items.push(...frame.datas); });
                            }
                            const invCache = {};
                            items.forEach(item => {
                                if (item.variable && item.value !== undefined) {
                                    invCache[item.variable] = item.value;
                                }
                            });
                            if (invCache.SoC !== undefined) {
                                document.getElementById('simSoC').value = invCache.SoC;
                                updated.push('SoC');
                            }
                            if (invCache.batTemperature !== undefined) {
                                document.getElementById('simBatteryTemp').value = invCache.batTemperature.toFixed(1);
                                updated.push('Battery temp');
                            }
                            if (invCache.ambientTemperation !== undefined) {
                                document.getElementById('simAmbientTemp').value = invCache.ambientTemperation.toFixed(1);
                                updated.push('Ambient temp');
                            }
                            if (invCache.invTemperation !== undefined) {
                                document.getElementById('simInverterTemp').value = invCache.invTemperation.toFixed(1);
                                updated.push('Inverter temp');
                            }
                            localStorage.setItem('cachedInverter', JSON.stringify(invCache));
                        }
                    }
                } catch (e) { log('warning', `Inverter fetch failed: ${e.message}`); }
                
                // Fetch Amber prices
                try {
                    console.log('[Fetch] userConfig:', userConfig);
                    let siteId = userConfig?.amberSiteId;
                    console.log('[Fetch] Initial siteId from config:', siteId);
                    
                    // If no siteId in config, fetch sites to get first one
                    if (!siteId && userConfig?.amberApiKey) {
                        try {
                            console.log('[Fetch] Fetching Amber sites...');
                            const sitesResp = await authenticatedFetch('/api/amber/sites');
                            console.log('[Fetch] Sites response status:', sitesResp.status);
                            if (sitesResp.ok) {
                                const sites = await sitesResp.json();
                                console.log('[Fetch] Sites data:', sites);
                                const sitesList = Array.isArray(sites) ? sites : (sites.result || []);
                                if (sitesList.length > 0) {
                                    siteId = sitesList[0].id;
                                    console.log('[Fetch] Found siteId:', siteId);
                                }
                            }
                        } catch (e) { console.error('[Fetch] Sites error:', e); }
                    }
                    
                    if (siteId) {
                        console.log('[Fetch] Fetching prices with siteId:', siteId);
                        const amberResp = await authenticatedFetch(`/api/amber/prices/current?siteId=${siteId}&next=48`);
                        console.log('[Fetch] Prices response status:', amberResp.status);
                        if (amberResp.ok) {
                            const amberData = await amberResp.json();
                            console.log('[Fetch] Amber data:', amberData);
                            // API can return array directly OR wrapped in {errno, result}
                            let prices = [];
                            if (Array.isArray(amberData)) {
                                prices = amberData;
                                console.log('[Fetch] Amber response is direct array, length:', prices.length);
                            } else if (amberData.errno === 0 && amberData.result) {
                                prices = Array.isArray(amberData.result) ? amberData.result : [];
                                console.log('[Fetch] Amber response is wrapped, extracted', prices.length, 'items');
                            } else {
                                console.log('[Fetch] Amber response format unknown:', {isArray: Array.isArray(amberData), errno: amberData?.errno, hasResult: !!amberData?.result});
                            }
                            console.log('[Fetch] Prices array length:', prices.length, 'isArray:', Array.isArray(prices));
                            if (prices.length > 0) {
                                console.log('[Fetch] First price item:', JSON.stringify(prices[0]).substring(0, 150));
                            }
                            const general = prices.find(p => p.channelType === 'general' && p.type === 'CurrentInterval');
                            const feedIn = prices.find(p => p.channelType === 'feedIn' && p.type === 'CurrentInterval');
                            console.log('[Fetch] Searching for current prices - General found:', !!general, 'FeedIn found:', !!feedIn);
                            if (general) {
                                console.log('[Fetch] General perKwh:', general.perKwh);
                            }
                            if (feedIn) {
                                console.log('[Fetch] FeedIn perKwh:', feedIn.perKwh);
                            }
                            const forecasts = prices.filter(p => p.type === 'ForecastInterval');
                            if (general?.perKwh !== undefined) {
                                document.getElementById('simBuy').value = general.perKwh.toFixed(1);
                                updated.push('Buy price');
                            }
                            if (feedIn?.perKwh !== undefined) {
                                document.getElementById('simFeedIn').value = (-feedIn.perKwh).toFixed(1);  // Negate for display
                                updated.push('Feed-in price');
                            }
                            if (forecasts.length > 0) {
                                const maxPrice = Math.max(...forecasts.map(f => f.perKwh || 0));
                                document.getElementById('simForecastHigh').value = maxPrice.toFixed(1);
                                updated.push('Forecast high');
                            }
                            const priceCache = {
                                general: general ? { perKwh: general.perKwh } : null,
                                feedIn: feedIn ? { perKwh: feedIn.perKwh } : null,
                                forecastHigh: forecasts.length > 0 ? Math.max(...forecasts.map(f => f.perKwh || 0)) : null
                            };
                            localStorage.setItem('cachedPrices', JSON.stringify(priceCache));
                        }
                    } else {
                        log('info', `Amber: No site ID or API key configured`);
                    }
                } catch (e) { 
                    console.error('[Fetch] Amber error caught:', e.message, e.stack); 
                    log('warning', `Amber fetch failed: ${e.message}`); 
                }
                
                // Fetch Weather
                try {
                    console.log('[Fetch] Fetching weather...');
                    const wxResp = await authenticatedFetch('/api/weather?days=1');
                    console.log('[Fetch] Weather response status:', wxResp.status);
                    if (wxResp.ok) {
                        const wxData = await wxResp.json();
                        console.log('[Fetch] Weather data:', wxData);
                        // API returns either wrapped {errno, result} or direct {source, hourly, ...}
                        let hourly = null;
                        if (wxData.errno === 0 && wxData.result?.hourly) {
                            hourly = wxData.result.hourly;
                        } else if (wxData.hourly) {
                            hourly = wxData.hourly;
                        }
                        
                        if (hourly) {
                            console.log('[Fetch] Hourly data:', hourly);
                            if (hourly.shortwave_radiation && Array.isArray(hourly.shortwave_radiation) && hourly.shortwave_radiation.length > 0) {
                                document.getElementById('simSolarRadiation').value = Math.round(hourly.shortwave_radiation[0]);
                                updated.push('Solar radiation');
                                console.log('[Fetch] Set solar radiation:', hourly.shortwave_radiation[0]);
                            }
                            // Check both cloudcover and cloud_cover (API might return either)
                            const cloudcoverArray = hourly.cloudcover || hourly.cloud_cover;
                            if (cloudcoverArray && Array.isArray(cloudcoverArray) && cloudcoverArray.length > 0) {
                                document.getElementById('simCloudCover').value = Math.round(cloudcoverArray[0]);
                                updated.push('Cloud cover');
                                console.log('[Fetch] Set cloud cover:', cloudcoverArray[0]);
                            }
                            const wxCache = {
                                solarRadiation: (hourly?.shortwave_radiation && hourly.shortwave_radiation[0]) || 0,
                                cloudCover: (cloudcoverArray && cloudcoverArray[0]) || 0
                            };
                            localStorage.setItem('cachedWeather', JSON.stringify(wxCache));
                        } else {
                            console.log('[Fetch] Weather response missing hourly data');
                        }
                    } else {
                        console.log('[Fetch] Weather response not OK:', wxResp.status);
                    }
                } catch (e) { console.error('[Fetch] Weather error:', e); log('warning', `Weather fetch failed: ${e.message}`); }
                
                if (updated.length > 1) {
                    log('success', `‚úÖ Fetched and cached: ${updated.join(', ')}`);
                } else {
                    log('warning', `‚ö†Ô∏è Could not fetch all data. Check your config and API connections.`);
                }
            } catch (e) {
                log('error', `‚ùå Live fetch error: ${e.message}`);
            }
        }

        async function loadRules() {
            try {
                const resp = await authenticatedFetch('/api/automation/status');
                const data = await resp.json();
                if (data.errno === 0 && data.result) {
                    currentRules = data.result.rules || {};
                    renderRules(data.result);
                    log('success', `Loaded ${Object.keys(currentRules).length} rules`);
                }
            } catch (e) {
                log('error', 'Failed to load rules: ' + e.message);
            }
        }

        function renderRules(status) {
            const container = document.getElementById('rulesDisplay');
            let html = '';
            
            // Master status
            html += `<div style="padding:8px;margin-bottom:12px;background:${status.enabled ? 'rgba(126,231,135,0.1)' : 'rgba(248,81,73,0.1)'};border-radius:6px;font-size:0.85rem;display:flex;align-items:center;gap:8px">
                <span style="font-size:1.2rem">${status.enabled ? '‚úÖ' : '‚è∏Ô∏è'}</span>
                <span>Master: <strong style="color:${status.enabled ? 'var(--accent)' : 'var(--accent-red)'}">${status.enabled ? 'ACTIVE' : 'PAUSED'}</strong></span>
            </div>`;
            
            const rules = Object.entries(status.rules || {}).sort((a, b) => (a[1].priority || 99) - (b[1].priority || 99));
            
            if (rules.length === 0) {
                html += `<div class="empty-state"><div class="icon">üì≠</div><p>No rules configured</p></div>`;
            }
            
            for (const [key, rule] of rules) {
                const conditions = rule.conditions || {};
                let condHtml = '';
                
                // Helper to create styled condition badges
                const condBadge = (label, color, bgColor) => `<span style="display:inline-block;padding:4px 8px;border-radius:4px;font-size:0.7rem;background:${bgColor};color:${color};border:1px solid ${color};margin-right:4px;margin-bottom:4px;font-weight:600">${label}</span>`;
                
                // Price conditions with between support and colors
                if (conditions.feedInPrice?.enabled) {
                    const label = conditions.feedInPrice.operator === 'between' 
                        ? `Feed > ${conditions.feedInPrice.value}¬¢-${conditions.feedInPrice.value2}¬¢` 
                        : `Feed > ${conditions.feedInPrice.value}¬¢`;
                    condHtml += condBadge(label, '#7ee787', 'rgba(126, 231, 135, 0.15)');
                }
                if (conditions.buyPrice?.enabled) {
                    const label = conditions.buyPrice.operator === 'between'
                        ? `Buy < ${conditions.buyPrice.value}¬¢-${conditions.buyPrice.value2}¬¢`
                        : `Buy < ${conditions.buyPrice.value}¬¢`;
                    condHtml += condBadge(label, '#a371f7', 'rgba(163, 113, 247, 0.15)');
                }
                if (conditions.soc?.enabled) {
                    const label = conditions.soc.operator === 'between'
                        ? `SoC ${conditions.soc.value}%-${conditions.soc.value2}%`
                        : `SoC ${conditions.soc.operator} ${conditions.soc.value}%`;
                    condHtml += condBadge(label, '#ffd43b', 'rgba(255, 212, 59, 0.15)');
                }
                if (conditions.temperature?.enabled) {
                    const label = `${conditions.temperature.type === 'battery' ? 'bat' : conditions.temperature.type === 'ambient' ? 'ambient' : 'inv'} ${conditions.temperature.operator} ${conditions.temperature.value}¬∞C`;
                    condHtml += condBadge(label, '#ff922b', 'rgba(255, 146, 43, 0.15)');
                }
                if (conditions.solarRadiation?.enabled) {
                    const sr = conditions.solarRadiation;
                    const label = `‚òÄÔ∏è ${sr.check || 'avg'} ${sr.operator} ${sr.value}W/m¬≤`;
                    condHtml += condBadge(label, '#ffd43b', 'rgba(255, 212, 59, 0.15)');
                }
                if (conditions.cloudCover?.enabled) {
                    const cc = conditions.cloudCover;
                    const label = `‚òÅÔ∏è ${cc.check || 'avg'} ${cc.operator} ${cc.value}%`;
                    condHtml += condBadge(label, '#58a6ff', 'rgba(88, 166, 255, 0.15)');
                }
                if (conditions.forecastPrice?.enabled) {
                    const fp = conditions.forecastPrice;
                    const label = `üìà ${fp.type === 'feedIn' ? 'FI' : 'Buy'} ${fp.check || 'max'} ${fp.operator} ${fp.value}¬¢`;
                    condHtml += condBadge(label, '#79c0ff', 'rgba(121, 192, 255, 0.15)');
                }
                // Handle both 'time' and legacy 'timeWindow' formats
                const timeCond = conditions.time || conditions.timeWindow;
                if (timeCond?.enabled) {
                    const label = `${timeCond.startTime || timeCond.start}-${timeCond.endTime || timeCond.end}`;
                    condHtml += condBadge(label, '#79c0ff', 'rgba(121, 192, 255, 0.15)');
                }
                
                const action = rule.action || {};
                const priorityClass = rule.priority <= 1 ? 'p1' : rule.priority === 2 ? 'p2' : rule.priority === 3 ? 'p3' : (rule.priority === 4 || rule.priority === 5) ? 'p4' : 'p-low';
                html += `
                <div class="rule-card ${rule.enabled ? '' : 'disabled'}" id="rule-${key}">
                    <div class="rule-header">
                        <span class="rule-name">
                            <span class="priority-badge ${priorityClass}" title="Priority ${rule.priority || '?'} (lower number = higher priority)">P${rule.priority || '?'}</span>
                            ${rule.name || key}
                        </span>
                        <span class="rule-status ${rule.enabled ? 'enabled' : 'disabled'}">${rule.enabled ? 'ON' : 'OFF'}</span>
                    </div>
                    <div style="margin-bottom:6px">${condHtml || '<span style="color:var(--text-secondary);font-size:0.75rem">No conditions</span>'}</div>
                    <div class="rule-params">
                        <div class="rule-param"><span class="label">‚Üí</span> <span class="value">${action.workMode || 'N/A'}</span></div>
                        <div class="rule-param"><span class="label">‚è±</span> <span class="value">${action.durationMinutes || 0}m</span></div>
                        <div class="rule-param"><span class="label">‚ö°</span> <span class="value">${action.fdPwr || 0}W</span></div>
                    </div>
                    <div class="rule-actions">
                        <button class="btn-secondary" onclick="editRule('${key}')">‚úèÔ∏è Edit</button>
                        <button class="btn-secondary" onclick="testSingleRule('${key}')">üß™ Test</button>
                        <button class="btn-danger" onclick="deleteRule('${key}')">üóëÔ∏è</button>
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        async function runTest() {
            const mockData = {
                feedInPrice: parseFloat(document.getElementById('simFeedIn').value) || 0,
                buyPrice: parseFloat(document.getElementById('simBuy').value) || 0,
                soc: parseFloat(document.getElementById('simSoC').value) || 50,
                batteryTemp: parseFloat(document.getElementById('simBatteryTemp').value) || 25,
                ambientTemp: parseFloat(document.getElementById('simAmbientTemp').value) || 20,
                inverterTemp: parseFloat(document.getElementById('simInverterTemp').value) || 35,
                solarRadiation: parseFloat(document.getElementById('simSolarRadiation').value) || 0,
                cloudCover: parseFloat(document.getElementById('simCloudCover').value) || 0,
                forecastHigh: parseFloat(document.getElementById('simForecastHigh').value) || 0,
                testTime: document.getElementById('simTime').value || null
            };
            
            const timeStr = mockData.testTime ? ` Time=${mockData.testTime}` : '';
            log('info', `Testing: FI=${mockData.feedInPrice}¬¢, Buy=${mockData.buyPrice}¬¢, SoC=${mockData.soc}%, BatTemp=${mockData.batteryTemp}¬∞C, Solar=${mockData.solarRadiation}W/m¬≤, Cloud=${mockData.cloudCover}%${timeStr}`);
            
            // Show loading state
            const resultsContainer = document.getElementById('testResults');
            resultsContainer.innerHTML = `
                <div class="result-box" style="border-color:var(--accent-blue)">
                    <div class="result-title">
                        <span style="display:inline-block;animation:spin 1s linear infinite">‚öôÔ∏è</span>
                        Running Test...
                    </div>
                    <p style="color:var(--text-secondary);margin-top:8px">Evaluating automation rules with mock conditions...</p>
                </div>
            `;
            
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 15000);
                
                const resp = await authenticatedFetch('/api/automation/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mockData }),
                    signal: controller.signal
                });
                clearTimeout(timeout);
                
                const result = await resp.json();
                
                // Update rules display to highlight triggered rule
                document.querySelectorAll('.rule-card').forEach(el => el.classList.remove('triggered'));
                
                if (result.errno === 0) {
                    if (result.triggered) {
                        const ruleName = result.result.ruleName;
                        log('success', `‚úì TRIGGERED: ${ruleName} ‚Üí ${result.result.action?.workMode}`);
                        
                        // Highlight triggered rule
                        const ruleEl = document.getElementById(`rule-${ruleName}`);
                        if (ruleEl) ruleEl.classList.add('triggered');
                        
                        // Add to mock scheduler
                        addMockSegment(result.result);
                        
                        // Show API payload
                        showApiPayload(result.result);
                        
                        showResult('triggered', result);
                    } else {
                        log('warn', 'No rules triggered with current conditions');
                        showResult('not-triggered', result);
                        document.getElementById('apiPayload').textContent = '// No action would be taken';
                    }
                } else {
                    log('error', 'Test error: ' + (result.error || 'Unknown'));
                    showResult('error', result);
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    log('error', 'Request timed out');
                } else {
                    log('error', 'Test failed: ' + e.message);
                }
                showResult('error', { error: e.message });
            }
        }

        async function testSingleRule(ruleName) {
            log('info', `Testing single rule: ${ruleName}`);
            runTest();
        }

        function showResult(type, data) {
            const container = document.getElementById('testResults');
            const icons = { 'triggered': '‚úÖ', 'not-triggered': '‚ö†Ô∏è', 'error': '‚ùå' };
            const titles = { 'triggered': 'Rule Would Trigger!', 'not-triggered': 'No Rules Matched', 'error': 'Test Error' };

            // allResults can be returned at top-level or under data.result depending on backend shape
            const allResults = data.allResults || (data.result && data.result.allResults) || [];

            function renderConditionList(condArr, ruleMatched = false) {
                if (!condArr || condArr.length === 0) return '<div style="color:var(--text-secondary);font-size:0.85rem">No conditions</div>';
                
                // Define the order of conditions to match renderRules
                const conditionOrder = ['feedInPrice', 'buyPrice', 'soc', 'temperature', 'solarRadiation', 'cloudCover', 'forecastPrice', 'timeWindow', 'time'];
                
                // Sort conditions array by their type/name according to the defined order
                const sortedConds = condArr.slice().sort((a, b) => {
                    // Try to determine condition type from name
                    let aType = '', bType = '';
                    
                    // Match condition names to types
                    if (a.name.includes('Feed')) aType = 'feedInPrice';
                    else if (a.name.includes('Buy')) aType = 'buyPrice';
                    else if (a.name.includes('SoC') || a.name.includes('Battery')) aType = 'soc';
                    else if (a.name.includes('Temp') || a.name.includes('Temperature')) aType = 'temperature';
                    else if (a.name.includes('Solar') || a.name.includes('Radiation')) aType = 'solarRadiation';
                    else if (a.name.includes('Cloud') || a.name.includes('Cover')) aType = 'cloudCover';
                    else if (a.name.includes('Forecast') || a.name.includes('Price')) aType = 'forecastPrice';
                    else if (a.name.includes('Time')) aType = 'timeWindow';
                    
                    if (b.name.includes('Feed')) bType = 'feedInPrice';
                    else if (b.name.includes('Buy')) bType = 'buyPrice';
                    else if (b.name.includes('SoC') || b.name.includes('Battery')) bType = 'soc';
                    else if (b.name.includes('Temp') || b.name.includes('Temperature')) bType = 'temperature';
                    else if (b.name.includes('Solar') || b.name.includes('Radiation')) bType = 'solarRadiation';
                    else if (b.name.includes('Cloud') || b.name.includes('Cover')) bType = 'cloudCover';
                    else if (b.name.includes('Forecast') || b.name.includes('Price')) bType = 'forecastPrice';
                    else if (b.name.includes('Time')) bType = 'timeWindow';
                    
                    const aIndex = conditionOrder.indexOf(aType);
                    const bIndex = conditionOrder.indexOf(bType);
                    
                    return (aIndex === -1 ? 999 : aIndex) - (bIndex === -1 ? 999 : bIndex);
                });
                
                return `<div style="display:flex;flex-direction:column;gap:8px">` + sortedConds.map(c => {
                    const isMet = c.met;
                    const bgColor = isMet ? 'rgba(126, 231, 135, 0.15)' : 'rgba(248, 81, 73, 0.15)';
                    const borderColor = isMet ? '#7ee787' : '#f85149';
                    const textColor = isMet ? '#7ee787' : '#f85149';
                    const icon = isMet ? '‚úì' : '‚úó';
                    const target = (c.target !== undefined && c.target !== null) ? c.target : '';
                    
                    return `
                        <div style="display:flex;align-items:stretch;gap:0;border-radius:6px;overflow:hidden;border-left:3px solid ${borderColor}">
                            <div style="display:flex;align-items:center;justify-content:center;width:36px;background:${bgColor};padding:8px;flex-shrink:0">
                                <span style="font-weight:700;color:${textColor};font-size:1.1rem">${icon}</span>
                            </div>
                            <div style="flex:1;padding:10px;background:${bgColor};display:flex;align-items:center;justify-content:space-between">
                                <div style="flex:1">
                                    <div style="font-weight:600;color:#e6edf3;font-size:0.9rem;margin-bottom:3px">${c.name}</div>
                                    <div style="font-size:0.8rem;color:var(--text-secondary);display:flex;gap:12px;flex-wrap:wrap">
                                        <span>Actual: <strong style="color:${textColor}">${c.value}</strong></span>
                                        ${target ? `<span>Target: <strong>${target}</strong></span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }).join('') + `</div>`;
            }

            function renderRuleCard(ruleInfo, isTriggered = false, triggeredRuleName = null) {
                const isTrigRule = ruleInfo.ruleName === triggeredRuleName;
                const allCondsMet = ruleInfo.conditions && ruleInfo.conditions.every(c => c.met);
                
                const cardBg = isTrigRule ? 'rgba(126, 231, 135, 0.1)' : 'rgba(248, 81, 73, 0.1)';
                const headerBg = isTrigRule ? 'rgba(126, 231, 135, 0.25)' : 'rgba(248, 81, 73, 0.15)';
                const borderColor = isTrigRule ? '#7ee787' : allCondsMet ? '#f0883e' : '#f85149';
                const statusIcon = isTrigRule ? '‚úÖ TRIGGERED' : allCondsMet ? '‚è≥ BLOCKED' : '‚ùå NOT MET';
                const statusColor = isTrigRule ? '#7ee787' : allCondsMet ? '#f0883e' : '#f85149';
                
                return `
                    <div style="background:${cardBg};border:2px solid ${borderColor};border-radius:8px;padding:12px;margin-bottom:12px;overflow:hidden">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid ${borderColor}">
                            <div style="display:flex;align-items:center;gap:12px;flex:1">
                                <div style="font-size:1.2rem;font-weight:700">${isTrigRule ? 'üéØ' : 'üìã'}</div>
                                <div>
                                    <div style="font-weight:700;color:#e6edf3;font-size:0.95rem">${ruleInfo.ruleName}</div>
                                    <div style="font-size:0.75rem;color:var(--text-secondary)">Priority P${ruleInfo.priority}</div>
                                </div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-weight:700;color:${statusColor};font-size:0.9rem">${statusIcon}</div>
                                <div style="font-size:0.7rem;color:var(--text-secondary);margin-top:2px">${ruleInfo.conditions ? ruleInfo.conditions.filter(c => c.met).length : 0}/${ruleInfo.conditions ? ruleInfo.conditions.length : 0} conditions met</div>
                            </div>
                        </div>
                        <div style="margin-bottom:12px">
                            ${renderConditionList(ruleInfo.conditions || [], isTrigRule)}
                        </div>
                        ${isTrigRule ? `
                            <div style="background:rgba(126, 231, 135, 0.2);border-left:3px solid #7ee787;padding:10px;border-radius:4px;font-size:0.85rem">
                                <strong style="color:#7ee787">‚ö° Action:</strong> ${ruleInfo.action ? ruleInfo.action.workMode + ' for ' + ruleInfo.action.durationMinutes + ' min' : 'N/A'}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            let detailsHtml = '';
            if (type === 'triggered' && data.result) {
                const r = data.result;
                const a = r.action || {};
                const triggeredRuleName = r.ruleName || r.ruleId;
                
                detailsHtml = `
                    <div style="background:rgba(126, 231, 135, 0.2);border:2px solid #7ee787;border-radius:8px;padding:14px;margin-bottom:16px">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                            <span style="font-size:1.5rem">üéØ</span>
                            <div>
                                <div style="font-weight:700;color:#7ee787;font-size:1rem">RULE TRIGGERED!</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary)">${r.ruleName} (P${r.priority})</div>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px">WORK MODE</div>
                                <div style="font-weight:700;color:#58a6ff;font-size:0.95rem">${a.workMode}</div>
                            </div>
                            <div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px">DURATION</div>
                                <div style="font-weight:700;color:#58a6ff;font-size:0.95rem">${a.durationMinutes} minutes</div>
                            </div>
                            <div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px">FD POWER</div>
                                <div style="font-weight:700;color:#58a6ff;font-size:0.95rem">${a.fdPwr}W</div>
                            </div>
                            <div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px">MIN SOC GRID</div>
                                <div style="font-weight:700;color:#58a6ff;font-size:0.95rem">${a.minSocOnGrid}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:16px">
                        <h4 style="font-size:0.9rem;color:#e6edf3;margin-bottom:12px;display:flex;align-items:center;gap:8px">
                            <span>‚úì</span> Triggered Rule Details
                        </h4>
                        ${renderRuleCard(allResults.find(x => x.ruleName === triggeredRuleName) || {ruleName: r.ruleName, priority: r.priority, action: a}, true, triggeredRuleName)}
                    </div>
                    
                    ${allResults.length > 1 ? `
                        <div>
                            <h4 style="font-size:0.9rem;color:#e6edf3;margin-bottom:12px;display:flex;align-items:center;gap:8px">
                                <span>‚ùå</span> Other Rules (Not Evaluated)
                            </h4>
                            ${allResults.filter(x => x.ruleName !== triggeredRuleName).map(r => renderRuleCard(r, false, triggeredRuleName)).join('')}
                        </div>
                    ` : ''}
                `;
            } else if (type === 'not-triggered') {
                // Show all rules checked and why they didn't match
                let ruleDetails = '';
                if (allResults && allResults.length > 0) {
                    // Separate rules by whether all conditions were met
                    const blocked = allResults.filter(r => r.conditions && r.conditions.every(c => c.met));
                    const notMet = allResults.filter(r => !r.conditions || !r.conditions.every(c => c.met));
                    
                    if (blocked.length > 0) {
                        ruleDetails += `
                            <div style="margin-bottom:16px">
                                <h4 style="font-size:0.9rem;color:#f0883e;margin-bottom:12px;display:flex;align-items:center;gap:8px">
                                    <span>‚è≥</span> All Conditions Met (Cooldown/Other Blocking)
                                </h4>
                                ${blocked.map(r => renderRuleCard(r, false)).join('')}
                            </div>
                        `;
                    }
                    
                    if (notMet.length > 0) {
                        ruleDetails += `
                            <div>
                                <h4 style="font-size:0.9rem;color:#f85149;margin-bottom:12px;display:flex;align-items:center;gap:8px">
                                    <span>‚ùå</span> Conditions Not Met
                                </h4>
                                ${notMet.map(r => renderRuleCard(r, false)).join('')}
                            </div>
                        `;
                    }
                }
                detailsHtml = `
                    <div style="background:rgba(248, 81, 73, 0.15);border:2px solid #f85149;border-radius:8px;padding:14px;margin-bottom:16px">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                            <span style="font-size:1.5rem">‚ö†Ô∏è</span>
                            <div style="font-weight:700;color:#f85149;font-size:1rem">No Rules Triggered</div>
                        </div>
                        <div style="font-size:0.9rem;color:var(--text-secondary)">The simulated conditions did not match any enabled rule. See rule details below.</div>
                    </div>
                    ${ruleDetails ? `<div>${ruleDetails}</div>` : ''}
                    <div style="margin-top:12px">
                        <h4 style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px">Test Conditions Used:</h4>
                        <pre style="background:var(--bg-card);padding:10px;border-radius:6px;font-size:0.8rem;overflow-x:auto">${JSON.stringify(data.testData, null, 2)}</pre>
                    </div>
                    <p style="margin-top:10px;font-size:0.85rem">Try adjusting values or check that rules are enabled.</p>
                `;
            } else {
                detailsHtml = `<pre style="color:var(--accent-red)">${JSON.stringify(data, null, 2)}</pre>`;
            }

            container.innerHTML = `
                <div class="result-box ${type}">
                    <div class="result-title">${icons[type]} ${titles[type]}</div>
                    ${detailsHtml}
                </div>
            `;
        }

        function addMockSegment(result) {
            const action = result.action || {};
            const now = new Date();
            const startTime = now.toTimeString().slice(0,5);
            const endDate = new Date(now.getTime() + (action.durationMinutes || 30) * 60000);
            const endTime = endDate.toTimeString().slice(0,5);
            
            const segment = {
                id: Date.now(),
                ruleName: result.ruleName,
                workMode: action.workMode,
                startTime,
                endTime,
                duration: action.durationMinutes,
                minSocOnGrid: action.minSocOnGrid,
                fdSoc: action.fdSoc,
                fdPwr: action.fdPwr,
                maxSoc: action.maxSoc,
                timestamp: now.toISOString()
            };
            
            // Replace existing segment - only Segment 1 exists on the inverter
            mockSchedulerSegments = [segment];
            renderMockScheduler();
        }

        function renderMockScheduler() {
            const container = document.getElementById('mockScheduler');
            
            if (mockSchedulerSegments.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="icon">üì≠</div><p>No pending segments</p></div>`;
                return;
            }
            
            let html = '';
            mockSchedulerSegments.forEach((seg, i) => {
                html += `
                <div class="scheduler-segment pending">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <span style="font-size:0.7rem;color:var(--accent-blue);margin-right:6px">SEGMENT 1</span>
                            <span class="segment-mode">${seg.workMode}</span>
                        </div>
                        <span style="font-size:0.75rem;color:var(--accent-yellow)">MOCK</span>
                    </div>
                    <div class="time-bar">
                        <div class="fill" style="left:0;width:100%"></div>
                    </div>
                    <div class="segment-info">
                        <span>${seg.startTime} ‚Üí ${seg.endTime}</span>
                        <span>${seg.duration}min</span>
                    </div>
                    <div style="margin-top:8px;font-size:0.75rem;color:var(--text-secondary);display:grid;grid-template-columns:1fr 1fr;gap:4px">
                        <div>From rule: <strong>${seg.ruleName}</strong></div>
                        <div>FD Power: <strong style="color:var(--accent)">${seg.fdPwr}W</strong></div>
                        <div>Min SoC (Grid): <strong style="color:var(--accent)">${seg.minSocOnGrid}%</strong></div>
                        <div>FD SoC: <strong style="color:var(--accent)">${seg.fdSoc}%</strong></div>
                        <div>Max SoC: <strong style="color:var(--accent)">${seg.maxSoc}%</strong></div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function clearMockScheduler() {
            mockSchedulerSegments = [];
            renderMockScheduler();
            log('info', 'Mock scheduler cleared');
        }

        function showApiPayload(result) {
            const action = result.action || {};
            const now = new Date();
            const startHour = now.getHours();
            const startMinute = now.getMinutes();
            const endDate = new Date(now.getTime() + (action.durationMinutes || 30) * 60000);
            
            const payload = {
                sn: "YOUR_DEVICE_SN",
                groups: [{
                    enable: true,
                    startHour: startHour,
                    startMinute: startMinute,
                    endHour: endDate.getHours(),
                    endMinute: endDate.getMinutes(),
                    workMode: action.workMode,
                    minSocOnGrid: action.minSocOnGrid || 20,
                    fdSoc: action.fdSoc || 35,
                    fdPwr: action.fdPwr || 0,
                    maxsoc: action.maxSoc || 100
                }]
            };
            
            document.getElementById('apiPayload').textContent = 
                `// POST /op/v0/device/scheduler/set\n` +
                JSON.stringify(payload, null, 2);
        }

        function log(level, message) {
            const container = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${level}">${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // Rule Management
        function showAddRuleModal(editData = null) {
            const isEdit = !!editData;
            
            // Pre-process time condition to handle both formats
            const timeCond = editData?.conditions?.time || editData?.conditions?.timeWindow;
            const timeEnabled = timeCond?.enabled || false;
            const timeStart = timeCond?.startTime || timeCond?.start || '06:00';
            const timeEnd = timeCond?.endTime || timeCond?.end || '18:00';
            
            // Pre-process other conditions
            const solarCond = editData?.conditions?.solarRadiation || {};
            const cloudCond = editData?.conditions?.cloudCover || {};
            const forecastCond = editData?.conditions?.forecastPrice || {};
            
            // Build modal inner content (outer structure is static in HTML)
            const modalInnerHtml = `
                        <div class="modal-header">
                            <h3>${isEdit ? '‚úèÔ∏è Edit Rule' : '‚ûï Create Test Rule'}</h3>
                            <button class="modal-close" onclick="closeRuleModal()">√ó</button>
                        </div>
                        
                        <input type="hidden" id="editingRuleId" value="${editData?.id || ''}">
                        
                        <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:16px">
                            <div>
                                <label style="display:block;font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px">Rule Name</label>
                                <input type="text" id="ruleName" value="${editData?.name || ''}" placeholder="e.g., High Export Discharge" style="width:100%">
                            </div>
                            <div>
                                <label style="display:block;font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px">Priority (1=highest)</label>
                                <input type="number" id="rulePriority" value="${editData?.priority || 5}" min="1" max="99" style="width:100%">
                            </div>
                        </div>
                        
                        <!-- Conditions -->
                        <div style="background:var(--bg-card);border-radius:8px;padding:14px;margin-bottom:16px">
                            <h4 style="font-size:0.9rem;color:var(--accent-blue);margin-bottom:12px">üìã Conditions (ALL must match)</h4>
                            
                            <div style="display:flex;flex-direction:column;gap:10px">
                                <!-- Feed-in Price -->
                                <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-secondary);border-radius:6px;flex-wrap:wrap">
                                    <input type="checkbox" id="condFeedIn" ${editData?.conditions?.feedInPrice?.enabled ? 'checked' : ''}>
                                    <label style="min-width:120px;font-size:0.85rem">üí∞ Feed-in Price</label>
                                    <select id="condFeedInOp" style="width:80px" onchange="toggleBetween('FeedIn')">
                                        <option value=">" ${editData?.conditions?.feedInPrice?.operator === '>' ? 'selected' : ''}>&gt;</option>
                                        <option value=">=" ${editData?.conditions?.feedInPrice?.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                        <option value="<" ${editData?.conditions?.feedInPrice?.operator === '<' ? 'selected' : ''}>&lt;</option>
                                        <option value="<=" ${editData?.conditions?.feedInPrice?.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                        <option value="between" ${editData?.conditions?.feedInPrice?.operator === 'between' ? 'selected' : ''}>between</option>
                                    </select>
                                    <input type="number" id="condFeedInVal" value="${editData?.conditions?.feedInPrice?.value || 25}" min="-100" max="500" style="width:70px">
                                    <span id="condFeedInVal2Wrap" style="display:${editData?.conditions?.feedInPrice?.operator === 'between' ? 'inline' : 'none'}">and <input type="number" id="condFeedInVal2" value="${editData?.conditions?.feedInPrice?.value2 || 50}" min="-100" max="500" style="width:60px"></span>
                                    <span>¬¢</span>
                                </div>
                                
                                <!-- Buy Price -->
                                <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-secondary);border-radius:6px;flex-wrap:wrap">
                                    <input type="checkbox" id="condBuy" ${editData?.conditions?.buyPrice?.enabled ? 'checked' : ''}>
                                    <label style="min-width:120px;font-size:0.85rem">üõí Buy Price</label>
                                    <select id="condBuyOp" style="width:80px" onchange="toggleBetween('Buy')">
                                        <option value="<" ${editData?.conditions?.buyPrice?.operator === '<' ? 'selected' : ''}>&lt;</option>
                                        <option value="<=" ${editData?.conditions?.buyPrice?.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                        <option value=">" ${editData?.conditions?.buyPrice?.operator === '>' ? 'selected' : ''}>&gt;</option>
                                        <option value=">=" ${editData?.conditions?.buyPrice?.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                        <option value="between" ${editData?.conditions?.buyPrice?.operator === 'between' ? 'selected' : ''}>between</option>
                                    </select>
                                    <input type="number" id="condBuyVal" value="${editData?.conditions?.buyPrice?.value || 10}" min="-100" max="500" style="width:70px">
                                    <span id="condBuyVal2Wrap" style="display:${editData?.conditions?.buyPrice?.operator === 'between' ? 'inline' : 'none'}">and <input type="number" id="condBuyVal2" value="${editData?.conditions?.buyPrice?.value2 || 20}" min="-100" max="500" style="width:60px"></span>
                                    <span>¬¢</span>
                                </div>
                                
                                <!-- SoC -->
                                <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-secondary);border-radius:6px;flex-wrap:wrap">
                                    <input type="checkbox" id="condSoc" ${editData?.conditions?.soc?.enabled ? 'checked' : ''}>
                                    <label style="min-width:120px;font-size:0.85rem">üîã Battery SoC</label>
                                    <select id="condSocOp" style="width:80px" onchange="toggleBetween('Soc')">
                                        <option value=">" ${editData?.conditions?.soc?.operator === '>' ? 'selected' : ''}>&gt;</option>
                                        <option value=">=" ${editData?.conditions?.soc?.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                        <option value="<" ${editData?.conditions?.soc?.operator === '<' ? 'selected' : ''}>&lt;</option>
                                        <option value="<=" ${editData?.conditions?.soc?.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                        <option value="between" ${editData?.conditions?.soc?.operator === 'between' ? 'selected' : ''}>between</option>
                                    </select>
                                    <input type="number" id="condSocVal" value="${editData?.conditions?.soc?.value || 50}" min="0" max="100" style="width:70px">
                                    <span id="condSocVal2Wrap" style="display:${editData?.conditions?.soc?.operator === 'between' ? 'inline' : 'none'}">and <input type="number" id="condSocVal2" value="${editData?.conditions?.soc?.value2 || 80}" min="0" max="100" style="width:60px"></span>
                                    <span>%</span>
                                </div>
                                
                                <!-- Temperature -->
                                <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-secondary);border-radius:6px;flex-wrap:wrap">
                                    <input type="checkbox" id="condTemp" ${editData?.conditions?.temperature?.enabled ? 'checked' : ''}>
                                    <label style="min-width:120px;font-size:0.85rem">üå°Ô∏è Temperature</label>
                                    <select id="condTempType" style="width:80px">
                                        <option value="battery" ${editData?.conditions?.temperature?.type === 'battery' ? 'selected' : ''}>Battery</option>
                                        <option value="ambient" ${editData?.conditions?.temperature?.type === 'ambient' ? 'selected' : ''}>Ambient</option>
                                        <option value="inverter" ${editData?.conditions?.temperature?.type === 'inverter' ? 'selected' : ''}>Inverter</option>
                                    </select>
                                    <select id="condTempOp" style="width:70px">
                                        <option value="<" ${editData?.conditions?.temperature?.operator === '<' ? 'selected' : ''}>&lt;</option>
                                        <option value="<=" ${editData?.conditions?.temperature?.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                        <option value=">" ${editData?.conditions?.temperature?.operator === '>' ? 'selected' : ''}>&gt;</option>
                                        <option value=">=" ${editData?.conditions?.temperature?.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                    </select>
                                    <input type="number" id="condTempVal" value="${editData?.conditions?.temperature?.value || 40}" min="-40" max="80" style="width:60px"> ¬∞C
                                </div>
                                
                                <!-- Solar Radiation -->
                                <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-secondary);border-radius:6px;flex-wrap:wrap">
                                    <input type="checkbox" id="condSolar" ${solarCond.enabled ? 'checked' : ''}>
                                    <label style="min-width:120px;font-size:0.85rem">‚òÄÔ∏è Solar Radiation</label>
                                    <select id="condSolarCheck" style="width:70px">
                                        <option value="average" ${solarCond.check === 'average' ? 'selected' : ''}>Avg</option>
                                        <option value="min" ${solarCond.check === 'min' ? 'selected' : ''}>Min</option>
                                        <option value="max" ${solarCond.check === 'max' ? 'selected' : ''}>Max</option>
                                    </select>
                                    <select id="condSolarOp" style="width:70px">
                                        <option value=">" ${solarCond.operator === '>' ? 'selected' : ''}>&gt;</option>
                                        <option value=">=" ${solarCond.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                        <option value="<" ${solarCond.operator === '<' ? 'selected' : ''}>&lt;</option>
                                        <option value="<=" ${solarCond.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                    </select>
                                    <input type="number" id="condSolarVal" value="${solarCond.value || 300}" min="0" max="1500" step="10" style="width:70px">
                                    <span style="font-size:0.8rem;color:var(--text-secondary)">W/m¬≤</span>
                                </div>
                                
                                <!-- Cloud Cover -->
                                <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-secondary);border-radius:6px;flex-wrap:wrap">
                                    <input type="checkbox" id="condCloud" ${cloudCond.enabled ? 'checked' : ''}>
                                    <label style="min-width:120px;font-size:0.85rem">‚òÅÔ∏è Cloud Cover</label>
                                    <select id="condCloudCheck" style="width:70px">
                                        <option value="average" ${cloudCond.check === 'average' ? 'selected' : ''}>Avg</option>
                                        <option value="min" ${cloudCond.check === 'min' ? 'selected' : ''}>Min</option>
                                        <option value="max" ${cloudCond.check === 'max' ? 'selected' : ''}>Max</option>
                                    </select>
                                    <select id="condCloudOp" style="width:70px">
                                        <option value="<" ${cloudCond.operator === '<' ? 'selected' : ''}>&lt;</option>
                                        <option value="<=" ${cloudCond.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                        <option value=">" ${cloudCond.operator === '>' ? 'selected' : ''}>&gt;</option>
                                        <option value=">=" ${cloudCond.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                    </select>
                                    <input type="number" id="condCloudVal" value="${cloudCond.value || 50}" min="0" max="100" style="width:60px"> %
                                </div>
                                
                                <!-- Forecast Price -->
                                <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-secondary);border-radius:6px;flex-wrap:wrap">
                                    <input type="checkbox" id="condForecast" ${forecastCond.enabled ? 'checked' : ''}>
                                    <label style="min-width:120px;font-size:0.85rem">üìà Forecast Price</label>
                                    <select id="condForecastType" style="width:70px">
                                        <option value="feedIn" ${forecastCond.type === 'feedIn' ? 'selected' : ''}>Feed-in</option>
                                        <option value="general" ${forecastCond.type === 'general' || !forecastCond.type ? 'selected' : ''}>Buy</option>
                                    </select>
                                    <select id="condForecastCheck" style="width:70px">
                                        <option value="average" ${forecastCond.check === 'average' ? 'selected' : ''}>Avg</option>
                                        <option value="min" ${forecastCond.check === 'min' ? 'selected' : ''}>Min</option>
                                        <option value="max" ${forecastCond.check === 'max' || !forecastCond.check ? 'selected' : ''}>Max</option>
                                        <option value="any" ${forecastCond.check === 'any' ? 'selected' : ''}>Any</option>
                                    </select>
                                    <select id="condForecastOp" style="width:70px">
                                        <option value=">" ${forecastCond.operator === '>' ? 'selected' : ''}>&gt;</option>
                                        <option value=">=" ${forecastCond.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                        <option value="<" ${forecastCond.operator === '<' ? 'selected' : ''}>&lt;</option>
                                        <option value="<=" ${forecastCond.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                    </select>
                                    <input type="number" id="condForecastVal" value="${forecastCond.value || 30}" min="-100" max="500" style="width:60px"> ¬¢
                                </div>
                                
                                <!-- Time Window -->
                                <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-secondary);border-radius:6px;flex-wrap:wrap">
                                    <input type="checkbox" id="condTime" ${timeEnabled ? 'checked' : ''}>
                                    <label style="min-width:120px;font-size:0.85rem">üïê Time Window</label>
                                    <input type="time" id="condTimeStart" value="${timeStart}">
                                    <span>to</span>
                                    <input type="time" id="condTimeEnd" value="${timeEnd}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action -->
                        <div style="background:var(--bg-card);border-radius:8px;padding:14px;margin-bottom:16px">
                            <h4 style="font-size:0.9rem;color:var(--accent);margin-bottom:12px">‚ö° Action</h4>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">
                                <div>
                                    <label style="display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:4px">Work Mode</label>
                                    <select id="actionMode" style="width:100%">
                                        <option value="ForceDischarge" ${editData?.action?.workMode === 'ForceDischarge' ? 'selected' : ''}>Force Discharge</option>
                                        <option value="ForceCharge" ${editData?.action?.workMode === 'ForceCharge' ? 'selected' : ''}>Force Charge</option>
                                        <option value="SelfUse" ${editData?.action?.workMode === 'SelfUse' ? 'selected' : ''}>Self Use</option>
                                        <option value="Feedin" ${editData?.action?.workMode === 'Feedin' ? 'selected' : ''}>Feed In</option>
                                        <option value="Backup" ${editData?.action?.workMode === 'Backup' ? 'selected' : ''}>Backup</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:4px">Duration (min)</label>
                                    <input type="number" id="actionDuration" value="${editData?.action?.durationMinutes || 30}" min="5" max="120" style="width:100%">
                                </div>
                                <div>
                                    <label style="display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:4px">Cooldown (min)</label>
                                    <input type="number" id="actionCooldown" value="${editData?.cooldownMinutes || 5}" min="1" max="60" style="width:100%">
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px">
                                <div>
                                    <label style="display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:4px">FD Power (W)</label>
                                    <input type="number" id="actionFdPwr" value="${editData?.action?.fdPwr || 7000}" min="0" max="10500" step="100" style="width:100%">
                                </div>
                                <div>
                                    <label style="display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:4px">FD SoC (%)</label>
                                    <input type="number" id="actionFdSoc" value="${editData?.action?.fdSoc || 35}" min="10" max="100" style="width:100%">
                                </div>
                                <div>
                                    <label style="display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:4px">Min SoC Grid</label>
                                    <input type="number" id="actionMinSoc" value="${editData?.action?.minSocOnGrid || 20}" min="10" max="100" style="width:100%">
                                </div>
                                <div>
                                    <label style="display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:4px">Max SoC (%)</label>
                                    <input type="number" id="actionMaxSoc" value="${editData?.action?.maxSoc || 90}" min="10" max="100" style="width:100%">
                                </div>
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:10px">
                            <button class="btn-secondary" style="flex:1" onclick="closeRuleModal()">Cancel</button>
                            <button class="btn-primary" style="flex:1" onclick="saveRule()">${isEdit ? 'Update Rule' : 'Create Rule'}</button>
                        </div>
            `;
            
            // Populate the static modal container and show it using direct style manipulation
            const modalContent = document.getElementById('ruleModalContent');
            const modalOverlay = document.getElementById('ruleModal');
            
            modalContent.innerHTML = modalInnerHtml;
            
            // Force modal to display centered with inline styles (bypasses any CSS conflicts)
            modalOverlay.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(0, 0, 0, 0.85) !important;
                backdrop-filter: blur(4px) !important;
                z-index: 999999 !important;
                padding: 20px !important;
                box-sizing: border-box !important;
                margin: 0 !important;
            `;
            
            // Lock background scroll
            document.body.classList.add('modal-open');
            
            // Close on Esc key
            const escHandler = (e) => { if (e.key === 'Escape') closeRuleModal(); };
            document.addEventListener('keydown', escHandler);
            modalOverlay._escHandler = escHandler;
        }

        // Toggle between value display for range operators
        function toggleBetween(type) {
            const op = document.getElementById('cond' + type + 'Op').value;
            const wrap = document.getElementById('cond' + type + 'Val2Wrap');
            if (wrap) {
                wrap.style.display = op === 'between' ? 'inline' : 'none';
            }
        }

        function closeRuleModal() {
            const modal = document.getElementById('ruleModal');
            if (modal) {
                // remove any Esc listener
                try {
                    const handler = modal._escHandler;
                    if (handler) document.removeEventListener('keydown', handler);
                } catch (e) {}
                // Hide the modal by clearing inline styles and setting display none
                modal.style.cssText = 'display: none !important;';
            }
            document.body.classList.remove('modal-open');
        }

        async function saveRule() {
            const editingId = document.getElementById('editingRuleId').value;
            const name = document.getElementById('ruleName').value.trim();
            
            if (!name) {
                alert('Please enter a rule name');
                return;
            }
            
            const ruleName = editingId || name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '') || ('rule_' + Date.now());
            
            // Build conditions including new types
            const feedInOp = document.getElementById('condFeedInOp').value;
            const buyOp = document.getElementById('condBuyOp').value;
            const socOp = document.getElementById('condSocOp').value;
            
            const conditions = {
                feedInPrice: {
                    enabled: document.getElementById('condFeedIn').checked,
                    operator: feedInOp,
                    value: parseFloat(document.getElementById('condFeedInVal').value) || 0,
                    ...(feedInOp === 'between' && { value2: parseFloat(document.getElementById('condFeedInVal2').value) || 50 })
                },
                buyPrice: {
                    enabled: document.getElementById('condBuy').checked,
                    operator: buyOp,
                    value: parseFloat(document.getElementById('condBuyVal').value) || 0,
                    ...(buyOp === 'between' && { value2: parseFloat(document.getElementById('condBuyVal2').value) || 20 })
                },
                soc: {
                    enabled: document.getElementById('condSoc').checked,
                    operator: socOp,
                    value: parseFloat(document.getElementById('condSocVal').value) || 50,
                    ...(socOp === 'between' && { value2: parseFloat(document.getElementById('condSocVal2').value) || 80 })
                },
                temperature: {
                    enabled: document.getElementById('condTemp').checked,
                    type: document.getElementById('condTempType').value,
                    operator: document.getElementById('condTempOp').value,
                    value: parseFloat(document.getElementById('condTempVal').value) || 40
                },
                solarRadiation: {
                    enabled: document.getElementById('condSolar').checked,
                    check: document.getElementById('condSolarCheck').value,
                    operator: document.getElementById('condSolarOp').value,
                    value: parseFloat(document.getElementById('condSolarVal').value) || 300
                },
                cloudCover: {
                    enabled: document.getElementById('condCloud').checked,
                    check: document.getElementById('condCloudCheck').value,
                    operator: document.getElementById('condCloudOp').value,
                    value: parseFloat(document.getElementById('condCloudVal').value) || 50
                },
                forecastPrice: {
                    enabled: document.getElementById('condForecast').checked,
                    type: document.getElementById('condForecastType').value,
                    check: document.getElementById('condForecastCheck').value,
                    operator: document.getElementById('condForecastOp').value,
                    value: parseFloat(document.getElementById('condForecastVal').value) || 30
                },
                time: {
                    enabled: document.getElementById('condTime').checked,
                    startTime: document.getElementById('condTimeStart').value || '00:00',
                    endTime: document.getElementById('condTimeEnd').value || '23:59'
                }
            };
            
            const hasCondition = Object.values(conditions).some(c => c.enabled);
            if (!hasCondition) {
                alert('Please enable at least one condition');
                return;
            }
            
            const payload = {
                ruleName,
                name,
                priority: parseInt(document.getElementById('rulePriority').value) || 5,
                conditions,
                cooldownMinutes: parseInt(document.getElementById('actionCooldown').value) || 5,
                enabled: true,
                action: {
                    workMode: document.getElementById('actionMode').value,
                    durationMinutes: parseInt(document.getElementById('actionDuration').value) || 30,
                    fdPwr: parseInt(document.getElementById('actionFdPwr').value) || 7000,
                    fdSoc: parseInt(document.getElementById('actionFdSoc').value) || 35,
                    minSocOnGrid: parseInt(document.getElementById('actionMinSoc').value) || 20,
                    maxSoc: parseInt(document.getElementById('actionMaxSoc').value) || 90
                }
            };
            
            try {
                const endpoint = editingId ? '/api/automation/rule/update' : '/api/automation/rule/create';
                const resp = await authenticatedFetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                
                if (data.errno === 0) {
                    log('success', `Rule ${editingId ? 'updated' : 'created'}: ${name}`);
                    closeRuleModal();
                    loadRules();
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function editRule(ruleName) {
            const rule = currentRules[ruleName];
            if (!rule) {
                alert('Rule not found');
                return;
            }
            showAddRuleModal({
                id: ruleName,
                name: rule.name || ruleName,
                priority: rule.priority,
                conditions: rule.conditions,
                cooldownMinutes: rule.cooldownMinutes,
                action: rule.action
            });
        }

        async function deleteRule(ruleName) {
            if (!confirm(`Delete rule "${ruleName}"?`)) return;
            
            try {
                const resp = await authenticatedFetch('/api/automation/rule/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ruleName })
                });
                const data = await resp.json();
                
                if (data.errno === 0) {
                    log('success', `Rule deleted: ${ruleName}`);
                    loadRules();
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // AppShell handles auth lifecycle; no additional bootstrap required here.
    </script>
</body>
</html>
